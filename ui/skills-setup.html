<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src https://fonts.gstatic.com;">
  <title>Skills - Pocket Agent</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Sora:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #0a0a0b;
      --bg-secondary: #141415;
      --bg-tertiary: #1c1c1e;
      --border: #2a2a2d;
      --text-primary: #fafafa;
      --text-secondary: #a1a1a6;
      --text-muted: #636366;
      --accent: #a855f7;
      --accent-secondary: #ec4899;
      --error: #ef4444;
      --success: #22c55e;
      --warning: #f59e0b;
      --radius-sm: 10px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Sora', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      height: 100vh;
      display: flex;
      flex-direction: column;
      -webkit-font-smoothing: antialiased;
    }

    header {
      background: var(--bg-secondary);
      padding: 16px 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }

    header h1 {
      font-size: 16px;
      font-weight: 700;
      background: linear-gradient(135deg, var(--text-primary) 0%, var(--accent) 100%);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .stats {
      font-size: 13px;
      color: var(--text-muted);
      margin-left: 12px;
    }

    .stats span { margin-right: 12px; }
    .stats .ready { color: var(--success); }
    .stats .missing { color: var(--warning); }

    .header-actions {
      display: flex;
      gap: 8px;
    }

    button {
      padding: 6px 14px;
      background: var(--bg-tertiary);
      color: var(--text-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s;
    }

    button:hover:not(:disabled) {
      background: var(--border);
      color: var(--text-primary);
    }

    button.primary {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
    }

    button.primary:hover:not(:disabled) {
      background: var(--accent-secondary);
      border-color: var(--accent-secondary);
    }

    button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .filters {
      padding: 12px 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      gap: 6px;
      background: var(--bg-secondary);
    }

    .filter {
      padding: 5px 10px;
      font-size: 12px;
      background: transparent;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      border-radius: 4px;
    }

    .filter:hover { color: var(--text-secondary); }
    .filter.active { background: var(--bg-tertiary); color: var(--text-primary); }

    .content {
      flex: 1;
      overflow-y: auto;
      contain: layout style;
    }

    .content::-webkit-scrollbar { width: 8px; }
    .content::-webkit-scrollbar-track { background: var(--bg-primary); }
    .content::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 10px 16px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }

    th {
      background: var(--bg-secondary);
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-secondary);
      position: sticky;
      top: 0;
    }

    td { font-size: 13px; }

    tr:hover { background: var(--bg-secondary); }

    .name {
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .name span { font-size: 16px; }

    .deps {
      color: var(--text-muted);
      font-family: 'SF Mono', monospace;
      font-size: 12px;
    }

    .deps.missing { color: var(--warning); }

    .deps .env-var {
      color: var(--accent);
      font-style: italic;
    }

    .deps .env-missing {
      color: var(--error);
    }

    .deps .perm-missing {
      color: var(--accent-secondary);
      cursor: pointer;
      text-decoration: underline;
      text-decoration-style: dotted;
    }

    .deps .perm-missing:hover {
      color: var(--accent);
    }

    .status {
      font-size: 11px;
      font-weight: 500;
      padding: 3px 8px;
      border-radius: 4px;
    }

    .status.ready { background: rgba(34, 197, 94, 0.15); color: var(--success); }
    .status.needs { background: rgba(245, 158, 11, 0.15); color: var(--warning); }
    .status.na { background: rgba(99, 99, 102, 0.1); color: var(--text-muted); }

    .actions { width: 110px; text-align: right; }

    .actions button {
      padding: 4px 10px;
      font-size: 12px;
      min-width: 90px;
      white-space: nowrap;
    }

    .actions .installing {
      background: transparent;
      border-color: var(--accent);
      color: var(--accent);
      cursor: default;
    }

    .actions .done {
      background: transparent;
      border-color: var(--success);
      color: var(--success);
      cursor: default;
    }

    .actions .failed {
      background: transparent;
      border-color: var(--error);
      color: var(--error);
      cursor: default;
    }

    .empty {
      text-align: center;
      padding: 60px 24px;
      color: var(--text-muted);
    }

    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 10px 16px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      font-size: 13px;
      opacity: 0;
      transform: translateY(10px);
      transition: all 0.2s;
      z-index: 100;
    }

    .toast.show { opacity: 1; transform: translateY(0); }
    .toast.success { border-color: var(--success); }
    .toast.error { border-color: var(--error); }
  </style>
</head>
<body>
  <header>
    <div style="display: flex; align-items: center;">
      <h1>Superpowers ğŸ¦¸</h1>
      <div class="stats" id="stats"></div>
    </div>
    <div class="header-actions">
      <button onclick="load()">Refresh</button>
      <button class="primary" id="install-btn" onclick="installAll()" disabled>Power Up All</button>
    </div>
  </header>

  <div class="filters">
    <button class="filter active" data-f="all" onclick="filter('all')">All</button>
    <button class="filter" data-f="ready" onclick="filter('ready')">Unlocked</button>
    <button class="filter" data-f="missing" onclick="filter('missing')">Locked</button>
  </div>

  <div class="content" id="content">
    <div class="empty">scanning powers...</div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    let data = [];
    let view = 'all';
    let installing = false;

    const emojis = {
      '1password':'ğŸ”','apple-notes':'ğŸ“','apple-reminders':'â°','bear-notes':'ğŸ»','bird':'ğŸ¦',
      'blogwatcher':'ğŸ“°','camsnap':'ğŸ“·','coding-agent':'ğŸ’»','discord':'ğŸ®',
      'food-order':'ğŸ•','gemini':'â™Š','gifgrep':'ğŸ¬','github':'ğŸ™','himalaya':'ğŸ“§','imsg':'ğŸ’¬',
      'notion':'ğŸ“”','obsidian':'ğŸ’','openhue':'ğŸ’¡','peekaboo':'ğŸ‘€','slack':'ğŸ’¼','sonoscli':'ğŸ”Š',
      'spotify-player':'ğŸ§','summarize':'ğŸ“','things-mac':'âœ…','tmux':'ğŸ–¥ï¸','trello':'ğŸ“‹',
      'wacli':'ğŸ“±','weather':'ğŸŒ¤ï¸'
    };

    async function load() {
      try {
        const r = await window.pocketAgent.getSkillsStatus();
        data = r.skills;
        document.getElementById('stats').innerHTML =
          `<span class="ready">${r.summary.available} unlocked</span><span class="missing">${r.summary.unavailable} locked</span>`;
        document.getElementById('install-btn').disabled = r.summary.unavailable === 0 || installing;
        render();
      } catch (e) {
        document.getElementById('content').innerHTML = '<div class="empty">Failed to load</div>';
      }
    }

    function render() {
      const c = document.getElementById('content');
      const list = data.filter(s => {
        if (view === 'all') return true;
        if (view === 'ready') return s.available;
        if (view === 'missing') return !s.available && s.osCompatible;
        return true;
      });

      if (!list.length) {
        c.innerHTML = '<div class="empty">no powers here yet!</div>';
        return;
      }

      c.innerHTML = `<table>
        <thead><tr><th>Power</th><th>Requirements</th><th>Status</th><th></th></tr></thead>
        <tbody>${list.map(s => {
          const e = emojis[s.name] || 'ğŸ”§';
          const st = s.available ? 'ready' : (s.osCompatible ? 'needs' : 'na');
          const stTxt = s.available ? 'Unlocked' : (s.osCompatible ? 'Locked' : 'N/A');

          // Build requirements display
          let depsHtml = '';
          let depsClass = '';

          if (s.missingBins && s.missingBins.length) {
            depsHtml += s.missingBins.map(b => `<span class="missing">${esc(b)}</span>`).join(', ');
            depsClass = 'missing';
          }

          if (s.missingEnvVars && s.missingEnvVars.length) {
            if (depsHtml) depsHtml += ', ';
            depsHtml += s.missingEnvVars.map(v => `<span class="env-missing">${esc(v)}</span>`).join(', ');
            depsClass = 'missing';
          }

          if (s.missingPermissions && s.missingPermissions.length) {
            if (depsHtml) depsHtml += ', ';
            depsHtml += s.missingPermissions.map(p =>
              `<span class="perm-missing" onclick="openPermission('${esc(p)}')" title="Click to grant">${esc(p)}</span>`
            ).join(', ');
            depsClass = 'missing';
          }

          if (!depsHtml) {
            depsHtml = s.available ? 'â€”' : 'none';
          }

          // Can only auto-install if only bins are missing (API keys and permissions need manual config)
          const hasMissingBins = s.missingBins && s.missingBins.length > 0;
          const hasMissingEnvVars = s.missingEnvVars && s.missingEnvVars.length > 0;
          const hasMissingPerms = s.missingPermissions && s.missingPermissions.length > 0;

          const canInstall = !s.available && s.osCompatible && s.installOptions.length
            && hasMissingBins && !hasMissingEnvVars && !hasMissingPerms;

          // Show "Add Key" button if only API keys are missing
          const needsApiKey = !s.available && s.osCompatible
            && !hasMissingBins && hasMissingEnvVars && !hasMissingPerms;

          // Show "Grant" button if only permissions are missing
          const needsPermission = !s.available && s.osCompatible
            && !hasMissingBins && !hasMissingEnvVars && hasMissingPerms;

          let btn = '';
          if (canInstall) {
            btn = `<button id="btn-${s.name}" onclick="install('${s.name}')">Unlock</button>`;
          } else if (needsApiKey) {
            btn = `<button id="btn-${s.name}" onclick="openSettings()">Add Key</button>`;
          } else if (needsPermission) {
            btn = `<button id="btn-${s.name}" onclick="openPermission('${s.missingPermissions[0]}')">Grant</button>`;
          }

          return `<tr id="row-${s.name}">
            <td class="name"><span>${e}</span>${esc(s.name)}</td>
            <td class="deps ${depsClass}">${depsHtml}</td>
            <td id="status-${s.name}"><span class="status ${st}">${stTxt}</span></td>
            <td class="actions">${btn}</td>
          </tr>`;
        }).join('')}</tbody>
      </table>`;
    }

    function filter(f) {
      view = f;
      document.querySelectorAll('.filter').forEach(b => b.classList.toggle('active', b.dataset.f === f));
      render();
    }

    function setButtonState(name, state) {
      const btn = document.getElementById(`btn-${name}`);
      if (!btn) return;

      btn.className = state;
      btn.disabled = true;
      btn.onclick = null;

      switch(state) {
        case 'installing':
          btn.textContent = 'Unlocking...';
          break;
        case 'done':
          btn.textContent = 'âœ“ Unlocked';
          break;
        case 'failed':
          btn.textContent = 'âœ— Failed';
          break;
      }
    }

    function updateRowStatus(name, available) {
      // Update the local data object
      const skill = data.find(s => s.name === name);
      if (skill) {
        skill.available = available;
        skill.missingBins = [];
      }

      // Update the status cell
      const statusCell = document.getElementById(`status-${name}`);
      if (statusCell) {
        statusCell.innerHTML = available
          ? '<span class="status ready">Unlocked</span>'
          : '<span class="status needs">Locked</span>';
      }

      // Update the deps cell to show no missing deps
      const row = document.getElementById(`row-${name}`);
      if (row && available) {
        const depsCell = row.querySelector('.deps');
        if (depsCell) {
          depsCell.textContent = 'â€”';
          depsCell.classList.remove('missing');
        }
      }
    }

    async function install(name) {
      if (installing) return;
      installing = true;
      document.getElementById('install-btn').disabled = true;

      setButtonState(name, 'installing');

      try {
        const r = await window.pocketAgent.installSkillDeps(name);
        if (r.success) {
          setButtonState(name, 'done');
          updateRowStatus(name, true);
          // Update stats count manually
          updateStatsCount();
          toast('Unlocked ' + name + '! ğŸ‰', 'success');
        } else {
          setButtonState(name, 'failed');
          toast('Oops: ' + r.failed.join(', '), 'error');
        }
      } catch (e) {
        setButtonState(name, 'failed');
        toast(e.message, 'error');
      }

      installing = false;
      document.getElementById('install-btn').disabled = false;
    }

    async function installAll() {
      if (installing) return;
      installing = true;
      document.getElementById('install-btn').disabled = true;

      const todo = data.filter(s => !s.available && s.osCompatible && s.installOptions.length);
      if (!todo.length) {
        installing = false;
        return;
      }

      let successCount = 0;
      let failCount = 0;

      for (const s of todo) {
        setButtonState(s.name, 'installing');

        try {
          const r = await window.pocketAgent.installSkillDeps(s.name);
          if (r.success) {
            setButtonState(s.name, 'done');
            updateRowStatus(s.name, true);
            successCount++;
          } else {
            setButtonState(s.name, 'failed');
            failCount++;
          }
        } catch (e) {
          setButtonState(s.name, 'failed');
          failCount++;
        }
      }

      installing = false;

      if (failCount === 0) {
        toast(`Unlocked ${successCount} powers! ğŸ‰`, 'success');
      } else {
        toast(`${successCount} unlocked, ${failCount} failed`, 'error');
      }

      // Update stats from local data
      updateStatsCount();
    }

    // Update stats from local data (doesn't fetch from backend)
    function updateStatsCount() {
      const available = data.filter(s => s.available).length;
      const unavailable = data.filter(s => !s.available && s.osCompatible).length;
      document.getElementById('stats').innerHTML =
        `<span class="ready">${available} unlocked</span><span class="missing">${unavailable} locked</span>`;
      document.getElementById('install-btn').disabled = unavailable === 0 || installing;
    }

    // Fetch fresh stats from backend
    async function updateStats() {
      try {
        const r = await window.pocketAgent.getSkillsStatus();
        data = r.skills;
        document.getElementById('stats').innerHTML =
          `<span class="ready">${r.summary.available} unlocked</span><span class="missing">${r.summary.unavailable} locked</span>`;
        document.getElementById('install-btn').disabled = r.summary.unavailable === 0 || installing;
      } catch (e) {
        // ignore
      }
    }

    function toast(msg, type) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.className = 'toast show ' + (type || '');
      setTimeout(() => t.classList.remove('show'), 2500);
    }

    function esc(s) {
      const d = document.createElement('div');
      d.textContent = s;
      return d.innerHTML;
    }

    async function openSettings() {
      try {
        await window.pocketAgent.openSettings();
      } catch (e) {
        toast('Failed to open settings', 'error');
      }
    }

    async function openPermission(permType) {
      try {
        await window.pocketAgent.openPermissionSettings(permType);
        toast('Opening System Settings...', 'success');
      } catch (e) {
        toast('Failed to open settings', 'error');
      }
    }

    load();
  </script>
</body>
</html>
