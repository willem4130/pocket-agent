<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src https://fonts.gstatic.com; img-src 'self' data:;">
  <title>Pocket Agent</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Sora:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    :root {
      --bg-primary: #0a0a0b;
      --bg-secondary: #141415;
      --bg-tertiary: #1c1c1e;
      --border: #2a2a2d;
      --text-primary: #fafafa;
      --text-secondary: #a1a1a6;
      --text-muted: #636366;
      --accent: #a855f7;
      --accent-secondary: #ec4899;
      --accent-hover: #c084fc;
      --user-bubble: linear-gradient(135deg, #a855f7 0%, #ec4899 100%);
      --user-bubble-solid: #a855f7;
      --assistant-bubble: #1c1c1e;
      --error: #ef4444;
      --success: #22c55e;
      --radius: 20px;
      --radius-sm: 10px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Sora', -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Segoe UI', system-ui, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      -webkit-font-smoothing: antialiased;
    }

    /* Header */
    header {
      background: var(--bg-secondary);
      padding: 10px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
      position: relative;
    }

    header::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, var(--accent) 0%, var(--accent-secondary) 50%, var(--accent) 100%);
      opacity: 0.5;
    }

    /* Session Tabs */
    .tabs-container {
      display: flex;
      align-items: center;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
      padding: 0 20px;
      gap: 4px;
      overflow-x: auto;
      flex-shrink: 0;
    }

    .tabs-container::-webkit-scrollbar {
      height: 0;
    }

    .tab {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-bottom: none;
      color: var(--text-secondary);
      font-size: 12px;
      font-weight: 500;
      cursor: grab;
      border-radius: 8px 8px 0 0;
      transition: background 0.15s ease, color 0.15s ease, transform 0.15s ease, opacity 0.15s ease, border-color 0.15s ease;
      white-space: nowrap;
      max-width: 180px;
      position: relative;
      user-select: none;
      margin-bottom: -1px;
    }

    .tab:hover {
      color: var(--text-primary);
      background: var(--bg-secondary);
      border-color: var(--text-muted);
    }

    .tab.active {
      color: var(--text-primary);
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-bottom: 1px solid var(--bg-primary);
    }

    .tab.dragging {
      opacity: 0.6;
      cursor: grabbing;
      background: var(--accent);
      border-color: var(--accent);
      color: white;
    }

    .tab.dragging .tab-close {
      color: rgba(255,255,255,0.7);
    }

    .tab-name {
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 120px;
    }

    .tab-name-input {
      background: transparent;
      border: 1px solid var(--accent);
      border-radius: 4px;
      color: var(--text-primary);
      font-size: 12px;
      font-weight: 500;
      padding: 2px 6px;
      width: 100px;
      outline: none;
    }

    .tab-close {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 16px;
      height: 16px;
      border-radius: 4px;
      background: transparent;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      padding: 0;
      line-height: 1;
      font-size: 14px;
      transition: all 0.15s ease;
      flex-shrink: 0;
    }

    .tab-close:hover {
      background: var(--error);
      color: white;
    }

    .new-tab-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 26px;
      height: 26px;
      background: transparent;
      border: 1px dashed var(--border);
      border-radius: 6px;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 18px;
      transition: all 0.15s ease;
      margin-left: 8px;
      flex-shrink: 0;
    }

    .new-tab-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
      background: rgba(168, 85, 247, 0.1);
    }

    header.loading::after {
      background: linear-gradient(
        90deg,
        var(--accent) 0%,
        var(--accent-secondary) 25%,
        var(--text-primary) 50%,
        var(--accent-secondary) 75%,
        var(--accent) 100%
      );
      background-size: 200% 100%;
      opacity: 0.8;
      animation: headerShimmer 1.5s ease-in-out infinite;
    }

    @keyframes headerShimmer {
      0% { background-position: 100% 0; }
      100% { background-position: -100% 0; }
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-secondary) 100%);
      box-shadow: 0 0 10px var(--accent);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.7; transform: scale(0.9); }
    }

    header h1 {
      font-family: 'Sora', sans-serif;
      font-size: 14px;
      font-weight: 700;
      letter-spacing: -0.02em;
      background: linear-gradient(135deg, var(--text-primary) 0%, var(--accent) 100%);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .stats {
      font-size: 11px;
      color: var(--text-muted);
      font-weight: 500;
    }

    /* Hamburger Menu */
    .hamburger-menu {
      position: relative;
    }

    .hamburger-btn {
      width: 28px;
      height: 28px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .hamburger-btn:hover {
      background: var(--border);
      transform: scale(1.05);
    }

    .hamburger-btn span {
      display: block;
      width: 14px;
      height: 2px;
      background: var(--text-secondary);
      border-radius: 1px;
      transition: all 0.2s ease;
    }

    .hamburger-btn:hover span {
      background: var(--text-primary);
    }

    .hamburger-btn.active span:nth-child(1) {
      transform: rotate(45deg) translate(4px, 4px);
    }

    .hamburger-btn.active span:nth-child(2) {
      opacity: 0;
    }

    .hamburger-btn.active span:nth-child(3) {
      transform: rotate(-45deg) translate(4px, -4px);
    }

    .menu-dropdown {
      position: absolute;
      top: calc(100% + 8px);
      right: 0;
      min-width: 180px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
      opacity: 0;
      visibility: hidden;
      transform: translateY(-8px);
      transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
      z-index: 100;
      overflow: hidden;
    }

    .menu-dropdown.open {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .menu-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 16px;
      background: transparent;
      border: none;
      width: 100%;
      text-align: left;
      color: var(--text-secondary);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .menu-item:hover {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }

    .menu-item svg {
      width: 16px;
      height: 16px;
      flex-shrink: 0;
    }

    .menu-item.danger:hover {
      color: var(--error);
    }

    .menu-divider {
      height: 1px;
      background: var(--border);
      margin: 4px 0;
    }

    /* Messages Container */
    #messages {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      scroll-behavior: smooth;
    }

    #messages::-webkit-scrollbar {
      width: 6px;
    }

    #messages::-webkit-scrollbar-track {
      background: transparent;
    }

    #messages::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 3px;
    }

    #messages::-webkit-scrollbar-thumb:hover {
      background: var(--text-muted);
    }

    /* Message Bubbles */
    .message {
      max-width: 80%;
      padding: 12px 16px;
      border-radius: var(--radius);
      line-height: 1.5;
      font-size: 14px;
      word-wrap: break-word;
      animation: messageIn 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      transform-origin: bottom;
    }

    @keyframes messageIn {
      0% {
        opacity: 0;
        transform: translateY(16px) scale(0.92);
      }
      50% {
        transform: translateY(-4px) scale(1.02);
      }
      75% {
        transform: translateY(2px) scale(0.99);
      }
      100% {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .message.user {
      align-self: flex-end;
      background: var(--user-bubble);
      color: white;
      border-bottom-right-radius: 6px;
      box-shadow: 0 4px 14px rgba(168, 85, 247, 0.25);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .message.user:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 20px rgba(168, 85, 247, 0.35);
    }

    .message.assistant {
      align-self: flex-start;
      background: var(--assistant-bubble);
      border: 1px solid var(--border);
      border-bottom-left-radius: 6px;
      color: var(--text-primary);
      transition: transform 0.2s ease, border-color 0.2s ease;
    }

    .message.assistant:hover {
      transform: translateY(-1px);
      border-color: var(--text-muted);
    }

    .message.system {
      align-self: center;
      background: transparent;
      color: var(--text-muted);
      font-size: 13px;
      padding: 8px 16px;
    }

    .message.reminder {
      align-self: flex-start;
      background: var(--assistant-bubble);
      border: 1px solid var(--accent);
      border-left: 3px solid var(--accent);
      color: var(--text-primary);
    }

    .reminder-header {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: var(--accent);
      margin-bottom: 6px;
      font-weight: 500;
    }

    .reminder-header svg {
      width: 14px;
      height: 14px;
      flex-shrink: 0;
    }

    .telegram-header {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: #0088cc;
      margin-bottom: 6px;
      font-weight: 500;
      opacity: 0.9;
    }

    .telegram-header svg {
      width: 14px;
      height: 14px;
      flex-shrink: 0;
    }

    .message.error {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: var(--error);
    }

    /* Code blocks in messages */
    .message code {
      background: rgba(0, 0, 0, 0.3);
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
      font-size: 13px;
    }

    .message pre {
      background: rgba(0, 0, 0, 0.4);
      padding: 12px;
      border-radius: var(--radius-sm);
      overflow-x: auto;
      margin: 8px 0;
    }

    .message pre code {
      background: none;
      padding: 0;
    }

    /* Markdown elements - tight spacing for chat */
    .message h1, .message h2, .message h3, .message h4 {
      margin: 1em 0 0.4em 0;
      font-weight: 600;
      line-height: 1.3;
    }

    .message h1:first-child, .message h2:first-child,
    .message h3:first-child, .message h4:first-child {
      margin-top: 0;
    }

    .message h1 { font-size: 1.2em; }
    .message h2 { font-size: 1.1em; }
    .message h3 { font-size: 1.05em; }
    .message h4 { font-size: 1em; }

    .message p {
      margin: 0;
    }

    .message p + p {
      margin-top: 0.5em;
    }

    .message > *:last-child {
      margin-bottom: 0 !important;
    }

    .message > *:first-child {
      margin-top: 0 !important;
    }

    .message ul, .message ol {
      margin: 0.3em 0;
      padding-left: 1.4em;
    }

    .message ul:first-child, .message ol:first-child { margin-top: 0; }
    .message ul:last-child, .message ol:last-child { margin-bottom: 0; }

    .message li {
      margin: 0;
      padding: 0;
      line-height: 1.5;
    }

    .message li + li {
      margin-top: 0.1em;
    }

    .message li p,
    .message li > p,
    .message li p:first-child,
    .message li p:last-child {
      margin: 0;
      padding: 0;
      display: inline;
    }

    .message a {
      color: #60a5fa;
      text-decoration: underline;
      text-decoration-color: rgba(96, 165, 250, 0.4);
      text-underline-offset: 2px;
    }

    .message a:hover {
      color: #93c5fd;
      text-decoration-color: rgba(147, 197, 253, 0.6);
    }

    .message.user a {
      color: #bfdbfe;
      text-decoration-color: rgba(191, 219, 254, 0.4);
    }

    .message.user a:hover {
      color: #ffffff;
      text-decoration-color: rgba(255, 255, 255, 0.6);
    }

    .message hr {
      border: none;
      border-top: 1px solid var(--border);
      margin: 0.6em 0;
    }

    .message blockquote {
      border-left: 3px solid var(--accent);
      padding-left: 0.8em;
      margin: 0.4em 0;
      color: var(--text-secondary);
    }

    .message table {
      border-collapse: collapse;
      margin: 0.5em 0;
      width: 100%;
      font-size: 0.95em;
    }

    .message th, .message td {
      border: 1px solid var(--border);
      padding: 0.4em 0.6em;
      text-align: left;
    }

    .message th {
      background: var(--bg-tertiary);
    }

    .message strong { font-weight: 600; }
    .message em { font-style: italic; }

    /* Status Indicator */
    .status-indicator {
      align-self: flex-start;
      padding: 12px 16px;
      background: var(--assistant-bubble);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      border-bottom-left-radius: 6px;
      display: flex;
      align-items: center;
      gap: 12px;
      animation: messageIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      max-width: 80%;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
    }

    .status-spinner {
      width: 18px;
      height: 18px;
      border: 2px solid rgba(168, 85, 247, 0.2);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      flex-shrink: 0;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .status-content {
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
    }

    .status-action {
      font-size: 13px;
      font-weight: 500;
      background: linear-gradient(
        90deg,
        var(--text-primary) 0%,
        var(--accent) 20%,
        var(--accent-secondary) 40%,
        var(--accent) 60%,
        var(--text-primary) 80%,
        var(--accent) 100%
      );
      background-size: 200% 100%;
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: shimmer 2s ease-in-out infinite;
    }

    @keyframes shimmer {
      0% { background-position: 100% 0; }
      100% { background-position: -100% 0; }
    }

    /* Subagent active state - purple/pink vibe */
    .status-indicator.subagent-active {
      border-color: #a855f7;
      background: linear-gradient(135deg, rgba(168, 85, 247, 0.1) 0%, rgba(236, 72, 153, 0.1) 100%);
    }

    .status-indicator.subagent-active .status-spinner {
      border-color: rgba(168, 85, 247, 0.3);
      border-top-color: #a855f7;
    }

    .status-indicator.subagent-active .status-action {
      background: linear-gradient(
        90deg,
        #a855f7 0%,
        #ec4899 25%,
        #a855f7 50%,
        #ec4899 75%,
        #a855f7 100%
      );
      background-size: 200% 100%;
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: shimmer 1.5s ease-in-out infinite;
    }

    .status-detail {
      font-size: 12px;
      color: var(--text-muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
    }

    /* Simple typing dots fallback */
    .typing {
      align-self: flex-start;
      padding: 14px 18px;
      background: var(--assistant-bubble);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      border-bottom-left-radius: 6px;
      display: flex;
      gap: 6px;
      animation: messageIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .typing-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--accent);
      animation: typingBounce 1.4s infinite ease-in-out both;
    }

    .typing-dot:nth-child(1) { animation-delay: -0.32s; background: var(--accent); }
    .typing-dot:nth-child(2) { animation-delay: -0.16s; background: linear-gradient(135deg, var(--accent) 0%, var(--accent-secondary) 100%); }
    .typing-dot:nth-child(3) { animation-delay: 0s; background: var(--accent-secondary); }

    @keyframes typingBounce {
      0%, 80%, 100% {
        transform: scale(0.7) translateY(0);
        opacity: 0.4;
      }
      40% {
        transform: scale(1.1) translateY(-4px);
        opacity: 1;
      }
    }

    /* Input Area */
    #input-area {
      padding: 16px 20px 20px 20px;
      background: var(--bg-secondary);
      border-top: 1px solid var(--border);
      display: flex;
      gap: 12px;
      align-items: flex-end;
      flex-shrink: 0;
    }

    .input-container {
      flex: 1;
      display: flex;
      align-items: flex-end;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 4px;
      transition: border-color 0.15s ease, box-shadow 0.15s ease;
    }

    .input-container:focus-within {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(168, 85, 247, 0.15), 0 0 20px rgba(168, 85, 247, 0.1);
    }

    .attach-btn {
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: none;
      border-radius: var(--radius-sm);
      cursor: pointer;
      color: var(--text-muted);
      transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
      flex-shrink: 0;
    }

    .attach-btn:hover {
      background: var(--border);
      color: var(--accent);
      transform: scale(1.1) rotate(-10deg);
    }

    .attach-btn:active {
      transform: scale(0.95) rotate(0deg);
    }

    .attach-btn svg {
      width: 18px;
      height: 18px;
    }

    #message-input {
      flex: 1;
      padding: 8px 12px;
      border: none;
      background: transparent;
      color: var(--text-primary);
      font-size: 14px;
      font-family: inherit;
      outline: none;
      resize: none;
      min-height: 24px;
      max-height: 150px;
      line-height: 1.5;
      position: relative;
      z-index: 1;
    }

    #message-input::placeholder {
      color: var(--text-muted);
    }

    #message-input.has-suggestion::placeholder {
      color: transparent;
    }

    .textarea-wrapper {
      position: relative;
      flex: 1;
      display: flex;
    }

    #ghost-suggestion {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      padding: 8px 12px;
      font-size: 14px;
      font-family: inherit;
      line-height: 1.5;
      color: var(--text-muted);
      pointer-events: none;
      white-space: pre-wrap;
      word-wrap: break-word;
      opacity: 0.6;
    }

    #ghost-suggestion .tab-hint {
      color: var(--accent);
      opacity: 0.7;
      font-size: 12px;
      margin-left: 8px;
    }

    #send-btn {
      width: 42px;
      height: 42px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-secondary) 100%);
      color: white;
      border: none;
      border-radius: 14px;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
      flex-shrink: 0;
      box-shadow: 0 4px 12px rgba(168, 85, 247, 0.3);
    }

    #send-btn:hover:not(:disabled) {
      transform: scale(1.08) rotate(-3deg);
      box-shadow: 0 6px 20px rgba(168, 85, 247, 0.45);
    }

    #send-btn:active:not(:disabled) {
      transform: scale(0.95) rotate(0deg);
    }

    #send-btn:disabled {
      background: var(--bg-tertiary);
      color: var(--text-muted);
      cursor: not-allowed;
      box-shadow: none;
    }

    #send-btn svg {
      width: 18px;
      height: 18px;
      transition: transform 0.2s ease;
    }

    #send-btn:hover:not(:disabled) svg {
      transform: translateX(2px) translateY(-2px);
    }

    #send-btn.stop-btn {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
    }

    #send-btn.stop-btn:hover {
      background: linear-gradient(135deg, #f87171 0%, #ef4444 100%);
      box-shadow: 0 6px 20px rgba(239, 68, 68, 0.45);
      transform: scale(1.08);
    }

    /* Empty State */
    .empty-state {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: var(--text-secondary);
      gap: 16px;
      padding: 40px;
      animation: emptyStateIn 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    @keyframes emptyStateIn {
      0% {
        opacity: 0;
        transform: scale(0.9) translateY(20px);
      }
      100% {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }

    .empty-state .empty-emoji {
      font-size: 56px;
      animation: wave 2.5s ease-in-out infinite;
      transform-origin: 70% 70%;
    }

    @keyframes wave {
      0%, 100% { transform: rotate(0deg); }
      10% { transform: rotate(14deg); }
      20% { transform: rotate(-8deg); }
      30% { transform: rotate(14deg); }
      40% { transform: rotate(-4deg); }
      50%, 100% { transform: rotate(0deg); }
    }

    .empty-state .empty-title {
      font-size: 20px;
      font-weight: 600;
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-secondary) 100%);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .empty-state .empty-subtitle {
      font-size: 14px;
      color: var(--text-muted);
      text-align: center;
      max-width: 280px;
    }

    .empty-state svg {
      width: 48px;
      height: 48px;
      opacity: 0.5;
    }

    .empty-state p {
      font-size: 14px;
      text-align: center;
    }

    /* Timestamp */
    .timestamp {
      font-size: 11px;
      color: var(--text-muted);
      text-align: center;
      padding: 8px 0;
    }

    /* File Input (hidden) */
    #file-input {
      display: none;
    }

    /* Attachments */
    .attachments-container {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      padding: 8px 12px;
      background: var(--bg-tertiary);
      border-top: 1px solid var(--border);
      max-height: 120px;
      overflow-y: auto;
    }

    .attachment-preview {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      font-size: 12px;
      color: var(--text-secondary);
      max-width: 200px;
    }

    .attachment-preview img {
      width: 32px;
      height: 32px;
      object-fit: cover;
      border-radius: 4px;
    }

    .attachment-icon {
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-tertiary);
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      flex-shrink: 0;
    }

    .attachment-info {
      flex: 1;
      min-width: 0;
      overflow: hidden;
    }

    .attachment-name {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      color: var(--text-primary);
    }

    .attachment-size {
      font-size: 11px;
      color: var(--text-muted);
    }

    .attachment-remove {
      width: 18px;
      height: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      color: var(--text-muted);
      font-size: 14px;
      line-height: 1;
      flex-shrink: 0;
    }

    .attachment-remove:hover {
      background: var(--border);
      color: var(--error);
    }

    /* Attachment in messages */
    .message-attachments {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 8px;
    }

    .message-attachment {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 6px;
      font-size: 12px;
    }

    .message-attachment img {
      max-width: 200px;
      max-height: 150px;
      border-radius: 6px;
    }
  </style>
</head>
<body>
  <header>
    <div class="header-left">
      <div class="status-dot"></div>
      <h1>Pocket Agent</h1>
    </div>
    <div class="header-right">
      <div class="stats" id="stats"></div>
      <div class="hamburger-menu">
        <button class="hamburger-btn" onclick="toggleMenu()" id="hamburger-btn">
          <span></span>
          <span></span>
          <span></span>
        </button>
        <div class="menu-dropdown" id="menu-dropdown">
          <button class="menu-item" onclick="clearChat(); closeMenu();">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
              <path d="M3 3v5h5"/>
            </svg>
            Fresh Start
          </button>
          <button class="menu-item" onclick="showFacts(); closeMenu();">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M12 2a10 10 0 1 0 10 10H12V2z"/>
              <path d="M12 2a10 10 0 0 1 10 10"/>
              <circle cx="12" cy="12" r="6"/>
              <circle cx="12" cy="12" r="2"/>
            </svg>
            My Brain
          </button>
          <button class="menu-item" onclick="openFactsGraph(); closeMenu();">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="6" cy="6" r="3"/>
              <circle cx="18" cy="6" r="3"/>
              <circle cx="6" cy="18" r="3"/>
              <circle cx="18" cy="18" r="3"/>
              <line x1="8.5" y1="7.5" x2="15.5" y2="16.5"/>
              <line x1="15.5" y1="7.5" x2="8.5" y2="16.5"/>
            </svg>
            Mind Map
          </button>
          <button class="menu-item" onclick="openCustomize(); closeMenu();">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M12 20h9"/>
              <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/>
            </svg>
            Personalize
          </button>
          <button class="menu-item" onclick="openRoutines(); closeMenu();">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"/>
              <polyline points="12 6 12 12 16 14"/>
            </svg>
            Routines
          </button>
          <div class="menu-divider"></div>
          <button class="menu-item" onclick="openSettings(); closeMenu();">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="3"/>
              <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
            </svg>
            Settings
          </button>
        </div>
      </div>
    </div>
  </header>

  <div class="tabs-container" id="tabs-container">
    <!-- Tabs will be populated by JavaScript -->
    <button class="new-tab-btn" onclick="createNewSession()" title="New chat">+</button>
  </div>

  <div id="messages"></div>

  <div id="input-area">
    <div class="input-container">
      <button class="attach-btn" onclick="triggerAttach()" title="Drop a file">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21.44 11.05l-9.19 9.19a6 6 0 01-8.49-8.49l9.19-9.19a4 4 0 015.66 5.66l-9.2 9.19a2 2 0 01-2.83-2.83l8.49-8.48"/>
        </svg>
      </button>
      <div class="textarea-wrapper">
        <div id="ghost-suggestion"></div>
        <textarea
          id="message-input"
          placeholder="what's on your mind? ✨"
          rows="1"
          onkeydown="handleKeydown(event)"
          oninput="handleInput(event)"
        ></textarea>
      </div>
    </div>
    <button id="send-btn" onclick="handleSendClick()" title="Send it!">
      <svg class="send-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <line x1="22" y1="2" x2="11" y2="13"/>
        <polygon points="22 2 15 22 11 13 2 9 22 2"/>
      </svg>
      <svg class="stop-icon" style="display: none;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
        <rect x="6" y="6" width="12" height="12" rx="2"/>
      </svg>
    </button>
  </div>

  <input type="file" id="file-input" onchange="handleFileSelect(event)" multiple
    accept=".txt,.md,.json,.csv,.xml,.html,.htm,.css,.js,.ts,.jsx,.tsx,.py,.rb,.go,.rs,.java,.c,.cpp,.h,.hpp,.sh,.yaml,.yml,.toml,.ini,.cfg,.conf,.log,.sql,.graphql,.pdf,.png,.jpg,.jpeg,.gif,.webp,.svg,.bmp,.ico">

  <script>
    const messagesDiv = document.getElementById('messages');
    const input = document.getElementById('message-input');
    const sendBtn = document.getElementById('send-btn');
    const statsDiv = document.getElementById('stats');
    const fileInput = document.getElementById('file-input');

    let isLoading = false;
    let pendingAttachments = []; // { file, name, type, size, dataUrl, content }
    let statusCleanup = null;
    let currentStatusEl = null;
    let currentSuggestion = null; // Stores the suggested prompt from the agent
    const ghostSuggestion = document.getElementById('ghost-suggestion');

    // Session state
    const MAX_TABS = 5;
    let sessions = [];
    let currentSessionId = 'default';
    const tabsContainer = document.getElementById('tabs-container');

    // Allowed file types
    const ALLOWED_EXTENSIONS = new Set([
      // Text/Code
      'txt', 'md', 'json', 'csv', 'xml', 'html', 'htm', 'css', 'js', 'ts', 'jsx', 'tsx',
      'py', 'rb', 'go', 'rs', 'java', 'c', 'cpp', 'h', 'hpp', 'sh', 'yaml', 'yml',
      'toml', 'ini', 'cfg', 'conf', 'log', 'sql', 'graphql',
      // Images
      'png', 'jpg', 'jpeg', 'gif', 'webp', 'svg', 'bmp', 'ico',
      // Documents
      'pdf'
    ]);

    const IMAGE_EXTENSIONS = new Set(['png', 'jpg', 'jpeg', 'gif', 'webp', 'svg', 'bmp', 'ico']);
    const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB

    // Initialize
    window.addEventListener('DOMContentLoaded', async () => {
      // Load sessions first, then load history for active session
      await loadSessions();
      await loadHistory();
      updateStats();
      input.focus();

      // Listen for scheduler messages
      window.pocketAgent.onSchedulerMessage((data) => {
        console.log('[Chat] Received scheduler message:', data.jobName);
        handleSchedulerMessage(data);
      });

      // Listen for Telegram messages (cross-channel sync)
      console.log('[Chat] Setting up Telegram message listener');
      window.pocketAgent.onTelegramMessage((data) => {
        console.log('[Chat] Received Telegram message:', data);
        handleTelegramMessage(data);
      });
      console.log('[Chat] Telegram message listener set up');
    });

    // ============ SESSION MANAGEMENT ============

    async function loadSessions() {
      try {
        sessions = await window.pocketAgent.getSessions();
        renderTabs();
        // Set current session to the first one (most recently active) or default
        if (sessions.length > 0) {
          currentSessionId = sessions[0].id;
        }
      } catch (err) {
        console.error('Failed to load sessions:', err);
      }
    }

    let draggedTab = null;
    let draggedSessionId = null;

    function renderTabs() {
      // Remove existing tabs (keep the new tab button)
      const existingTabs = tabsContainer.querySelectorAll('.tab');
      existingTabs.forEach(tab => tab.remove());

      // Add tabs before the new tab button
      const newTabBtn = tabsContainer.querySelector('.new-tab-btn');

      sessions.forEach((session, index) => {
        const tab = document.createElement('div');
        tab.className = 'tab' + (session.id === currentSessionId ? ' active' : '');
        tab.dataset.sessionId = session.id;
        tab.dataset.index = index;
        tab.draggable = true;

        tab.onclick = (e) => {
          if (!e.target.closest('.tab-close') && !e.target.closest('.tab-name-input')) {
            switchSession(session.id);
          }
        };
        tab.ondblclick = () => startRenameSession(session.id);

        // Drag events
        tab.ondragstart = (e) => {
          draggedTab = tab;
          draggedSessionId = session.id;
          setTimeout(() => tab.classList.add('dragging'), 0);
          e.dataTransfer.effectAllowed = 'move';
        };

        tab.ondragend = () => {
          if (draggedTab) {
            draggedTab.classList.remove('dragging');
          }
          draggedTab = null;
          draggedSessionId = null;
        };

        tab.ondragover = (e) => {
          e.preventDefault();
          if (!draggedTab || draggedSessionId === session.id) return;

          // Get the tab being hovered over
          const targetTab = tab;
          const rect = targetTab.getBoundingClientRect();
          const midpoint = rect.left + rect.width / 2;

          // Determine if we should insert before or after
          if (e.clientX < midpoint) {
            // Insert before this tab
            if (targetTab.previousElementSibling !== draggedTab) {
              tabsContainer.insertBefore(draggedTab, targetTab);
              updateSessionsOrder();
            }
          } else {
            // Insert after this tab
            if (targetTab.nextElementSibling !== draggedTab) {
              tabsContainer.insertBefore(draggedTab, targetTab.nextElementSibling);
              updateSessionsOrder();
            }
          }
        };

        const nameSpan = document.createElement('span');
        nameSpan.className = 'tab-name';
        nameSpan.textContent = session.name;
        tab.appendChild(nameSpan);

        // Don't show close button for default session if it's the only one
        if (session.id !== 'default' || sessions.length > 1) {
          const closeBtn = document.createElement('button');
          closeBtn.className = 'tab-close';
          closeBtn.innerHTML = '×';
          closeBtn.onclick = (e) => {
            e.stopPropagation();
            confirmDeleteSession(session.id, session.name);
          };
          tab.appendChild(closeBtn);
        }

        tabsContainer.insertBefore(tab, newTabBtn);
      });

      // Hide new tab button when at max capacity
      newTabBtn.style.display = sessions.length >= MAX_TABS ? 'none' : '';
    }

    function updateSessionsOrder() {
      // Update sessions array to match current DOM order
      const tabs = tabsContainer.querySelectorAll('.tab');
      const newOrder = [];
      tabs.forEach(tab => {
        const sessionId = tab.dataset.sessionId;
        const session = sessions.find(s => s.id === sessionId);
        if (session) newOrder.push(session);
      });
      sessions = newOrder;
    }

    function confirmDeleteSession(sessionId, sessionName) {
      if (sessions.length <= 1) return;

      if (confirm(`Delete "${sessionName}"? This will remove all messages in this chat.`)) {
        deleteSession(sessionId);
      }
    }

    async function switchSession(sessionId) {
      if (sessionId === currentSessionId || isLoading) return;

      currentSessionId = sessionId;
      renderTabs();
      messagesDiv.innerHTML = '';
      await loadHistory();
      updateStats();
      input.focus();
    }

    async function createNewSession() {
      // Check tab limit
      if (sessions.length >= MAX_TABS) {
        return;
      }

      try {
        const session = await window.pocketAgent.createSession('New');
        sessions.push(session); // Add to end (right side)
        currentSessionId = session.id;
        renderTabs();
        messagesDiv.innerHTML = '';
        showEmptyState();
        updateStats();
        input.focus();
        // Start rename immediately
        setTimeout(() => startRenameSession(session.id), 100);
      } catch (err) {
        console.error('Failed to create session:', err);
      }
    }

    function startRenameSession(sessionId) {
      const tab = tabsContainer.querySelector(`[data-session-id="${sessionId}"]`);
      if (!tab) return;

      const nameSpan = tab.querySelector('.tab-name');
      const currentName = nameSpan.textContent;

      const input = document.createElement('input');
      input.type = 'text';
      input.className = 'tab-name-input';
      input.value = currentName;
      input.maxLength = 10;

      // Sanitize input: single word only (no spaces), max 10 chars
      input.oninput = () => {
        // Remove spaces and limit to 10 chars
        input.value = input.value.replace(/\s/g, '').slice(0, 10);
      };

      input.onblur = () => finishRename(sessionId, input.value);
      input.onkeydown = (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          input.blur();
        } else if (e.key === 'Escape') {
          input.value = currentName;
          input.blur();
        } else if (e.key === ' ') {
          // Prevent space key
          e.preventDefault();
        }
      };

      nameSpan.replaceWith(input);
      input.focus();
      input.select();
    }

    async function finishRename(sessionId, newName) {
      // Sanitize: remove spaces, limit to 10 chars, fallback to 'Untitled'
      const sanitizedName = newName.replace(/\s/g, '').slice(0, 10) || 'Untitled';

      try {
        await window.pocketAgent.renameSession(sessionId, sanitizedName);
        // Update local state
        const session = sessions.find(s => s.id === sessionId);
        if (session) {
          session.name = sanitizedName;
        }
        renderTabs();
      } catch (err) {
        console.error('Failed to rename session:', err);
        renderTabs(); // Revert UI
      }
    }

    async function deleteSession(sessionId) {
      if (sessions.length <= 1) {
        // Can't delete the last session
        return;
      }

      try {
        await window.pocketAgent.deleteSession(sessionId);
        sessions = sessions.filter(s => s.id !== sessionId);

        // If we deleted the current session, switch to another
        if (sessionId === currentSessionId) {
          currentSessionId = sessions[0]?.id || 'default';
          messagesDiv.innerHTML = '';
          await loadHistory();
        }

        renderTabs();
        updateStats();
      } catch (err) {
        console.error('Failed to delete session:', err);
      }
    }

    function handleSchedulerMessage(data) {
      // Clear empty state if present
      const emptyState = messagesDiv.querySelector('.empty-state');
      if (emptyState) emptyState.remove();

      // Use the shared reminder rendering function
      addReminderFromHistory(data.jobName, data.prompt, true);

      // Add the agent's response
      addMessage('assistant', data.response);

      // Update stats and scroll
      updateStats();
      scrollToBottom();

      // Focus window
      window.focus();
    }

    function handleTelegramMessage(data) {
      // Clear empty state if present
      const emptyState = messagesDiv.querySelector('.empty-state');
      if (emptyState) emptyState.remove();

      // Add Telegram indicator + user message
      addTelegramMessage('user', data.userMessage);

      // Add the agent's response
      addMessage('assistant', data.response);

      // Update stats and scroll
      updateStats();
      scrollToBottom();
    }

    function addTelegramMessage(role, content) {
      const wrapper = document.createElement('div');
      wrapper.className = `message ${role}`;

      // Telegram icon SVG
      const telegramIcon = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="14" height="14"><path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/></svg>`;

      const header = document.createElement('div');
      header.className = 'telegram-header';
      header.innerHTML = `${telegramIcon} <span>via Telegram</span>`;

      const contentDiv = document.createElement('div');
      contentDiv.className = 'message-content';
      contentDiv.innerHTML = formatMessage(content);

      wrapper.appendChild(header);
      wrapper.appendChild(contentDiv);
      messagesDiv.appendChild(wrapper);

      return wrapper;
    }

    function addReminderFromHistory(jobName, prompt, animate = true) {
      // Create reminder message with icon
      const reminderDiv = document.createElement('div');
      reminderDiv.className = 'message reminder';
      if (!animate) reminderDiv.style.animation = 'none';

      const promptPreview = prompt.length > 100
        ? prompt.slice(0, 100) + '...'
        : prompt;

      // Clock icon SVG
      const clockIcon = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>`;

      reminderDiv.innerHTML = `
        <div class="reminder-header">
          ${clockIcon}
          <span>Scheduled: ${escapeHtml(jobName)}</span>
        </div>
        <div class="reminder-content">${escapeHtml(promptPreview)}</div>
      `;

      messagesDiv.appendChild(reminderDiv);
      return reminderDiv;
    }

    async function loadHistory() {
      try {
        const history = await window.pocketAgent.getHistory(100, currentSessionId);
        messagesDiv.innerHTML = '';

        if (history.length === 0) {
          showEmptyState();
        } else {
          let lastDate = null;
          for (let i = 0; i < history.length; i++) {
            const msg = history[i];
            // Add date separator if needed
            const msgDate = new Date(msg.timestamp).toLocaleDateString();
            if (msgDate !== lastDate) {
              addTimestamp(msgDate);
              lastDate = msgDate;
            }

            // Check if this is a scheduled reminder (user message starts with [Scheduled: ...])
            if (msg.role === 'user' && msg.content.startsWith('[Scheduled:')) {
              // Extract job name and prompt from [Scheduled: jobname] prompt
              const match = msg.content.match(/^\[Scheduled:\s*([^\]]+)\]\s*(.*)/s);
              if (match) {
                const jobName = match[1];
                const prompt = match[2];

                // Render as reminder
                addReminderFromHistory(jobName, prompt, false);

                // The next message should be the assistant's response
                if (i + 1 < history.length && history[i + 1].role === 'assistant') {
                  addMessage('assistant', history[i + 1].content, false);
                  i++; // Skip the next message since we've handled it
                }
                continue;
              }
            }

            addMessage(msg.role, msg.content, false);
          }
        }

        scrollToBottom(true); // Instant scroll on initial load
      } catch (err) {
        console.error('Failed to load history:', err);
        showEmptyState();
      }
    }

    async function updateStats() {
      try {
        const stats = await window.pocketAgent.getStats(currentSessionId);
        if (stats) {
          const tokens = stats.estimatedTokens >= 1000
            ? `${(stats.estimatedTokens / 1000).toFixed(1)}k`
            : stats.estimatedTokens;
          statsDiv.textContent = `${stats.messageCount} msgs · ${stats.factCount} facts · ${tokens} tokens`;
        }
      } catch (err) {
        console.error('Failed to get stats:', err);
      }
    }

    function handleSendClick() {
      if (isLoading) {
        stopQuery();
      } else {
        sendMessage();
      }
    }

    function setButtonState(loading) {
      const sendIcon = sendBtn.querySelector('.send-icon');
      const stopIcon = sendBtn.querySelector('.stop-icon');
      const header = document.querySelector('header');

      if (loading) {
        sendBtn.classList.add('stop-btn');
        sendBtn.title = 'Stop it!';
        sendIcon.style.display = 'none';
        stopIcon.style.display = 'block';
        sendBtn.disabled = false;
        header.classList.add('loading');
      } else {
        sendBtn.classList.remove('stop-btn');
        sendBtn.title = 'Send it!';
        sendIcon.style.display = 'block';
        stopIcon.style.display = 'none';
        header.classList.remove('loading');
      }
    }

    async function stopQuery() {
      try {
        await window.pocketAgent.stop();

        // Clean up status listener
        if (statusCleanup) {
          statusCleanup();
          statusCleanup = null;
        }

        // Remove status indicator
        if (currentStatusEl) {
          currentStatusEl.remove();
          currentStatusEl = null;
        }

        addMessage('system', 'Query stopped.');

        isLoading = false;
        setButtonState(false);
        scrollToBottom();
        input.focus();
      } catch (err) {
        console.error('Failed to stop query:', err);
      }
    }

    async function sendMessage() {
      const message = input.value.trim();
      const attachments = [...pendingAttachments];

      if ((!message && attachments.length === 0) || isLoading) return;

      // Clear empty state if present
      const emptyState = messagesDiv.querySelector('.empty-state');
      if (emptyState) emptyState.remove();

      isLoading = true;
      setButtonState(true);
      input.value = '';
      input.style.height = 'auto';
      clearSuggestion();

      // Clear attachments
      clearAttachments();

      // Show user message with attachments
      addMessage('user', message, true, attachments);
      currentStatusEl = addStatusIndicator('hmm let me think 🤔');
      scrollToBottom();

      // Build the full message with attachments
      const fullMessage = await buildMessageWithAttachments(message, attachments);

      // Set up status listener
      statusCleanup = window.pocketAgent.onStatus((status) => {
        updateStatusIndicator(status);
      });

      try {
        const result = await window.pocketAgent.send(fullMessage, currentSessionId);

        // Clean up status listener
        if (statusCleanup) {
          statusCleanup();
          statusCleanup = null;
        }

        // Remove status indicator
        if (currentStatusEl) {
          currentStatusEl.remove();
          currentStatusEl = null;
        }

        if (result.success) {
          addMessage('assistant', result.response);

          // If there's a suggested prompt, show it as ghost text
          if (result.suggestedPrompt) {
            setSuggestion(result.suggestedPrompt);
          }
        } else {
          addMessage('error', result.error);
        }

        updateStats();
      } catch (err) {
        // Clean up status listener
        if (statusCleanup) {
          statusCleanup();
          statusCleanup = null;
        }

        if (currentStatusEl) {
          currentStatusEl.remove();
          currentStatusEl = null;
        }

        // Don't show error if query was stopped
        if (!err.message?.includes('stopped')) {
          addMessage('error', err.message || 'Something went wrong');
        }
      }

      isLoading = false;
      setButtonState(false);
      scrollToBottom();
      input.focus();
    }

    async function buildMessageWithAttachments(message, attachments) {
      if (attachments.length === 0) return message;

      const parts = [];

      // Add text message if present
      if (message) {
        parts.push(message);
      }

      // Add attachments
      for (const att of attachments) {
        if (att.isImage && att.dataUrl) {
          // Save image to temp file and reference path
          try {
            const filePath = await window.pocketAgent.saveAttachment(att.name, att.dataUrl);
            parts.push(`\n\n[Attached image: ${att.name}]\nFile saved at: ${filePath}\nUse the Read tool to view this image.`);
          } catch (err) {
            parts.push(`\n\n[Image: ${att.name}] (failed to save: ${err.message})`);
          }
        } else if (att.ext === 'pdf' && att.dataUrl) {
          // Save PDF to temp file and reference path
          try {
            const filePath = await window.pocketAgent.saveAttachment(att.name, att.dataUrl);
            parts.push(`\n\n[Attached PDF: ${att.name}]\nFile saved at: ${filePath}\nUse the Read tool to view this PDF.`);
          } catch (err) {
            parts.push(`\n\n[PDF: ${att.name}] (failed to save: ${err.message})`);
          }
        } else if (att.content) {
          // For text files, include content directly (truncate if very large)
          const content = att.content.length > 50000
            ? att.content.slice(0, 50000) + '\n... (truncated)'
            : att.content;
          parts.push(`\n\n[File: ${att.name}]\n\`\`\`${att.ext}\n${content}\n\`\`\``);
        }
      }

      return parts.join('');
    }

    async function clearChat() {
      if (!confirm('Start fresh? Don\'t worry - I\'ll keep everything I know about you!')) return;

      try {
        await window.pocketAgent.clearConversation(currentSessionId);
        messagesDiv.innerHTML = '';
        showEmptyState();
        updateStats();
      } catch (err) {
        addMessage('error', err.message);
      }
    }

    async function showFacts() {
      try {
        await window.pocketAgent.openFacts();
      } catch (err) {
        console.error('Failed to open facts:', err);
      }
    }

    function addMessage(role, content, animate = true, attachments = []) {
      const div = document.createElement('div');
      div.className = `message ${role}`;
      if (!animate) div.style.animation = 'none';

      // Add attachments display for user messages
      if (attachments && attachments.length > 0) {
        const attDiv = document.createElement('div');
        attDiv.className = 'message-attachments';

        for (const att of attachments) {
          const attItem = document.createElement('div');
          attItem.className = 'message-attachment';

          if (att.isImage && att.dataUrl) {
            const img = document.createElement('img');
            img.src = att.dataUrl;
            img.alt = att.name;
            attItem.appendChild(img);
          } else {
            attItem.innerHTML = `<span class="attachment-icon">${escapeHtml(att.ext)}</span> ${escapeHtml(att.name)}`;
          }

          attDiv.appendChild(attItem);
        }

        div.appendChild(attDiv);
      }

      // Add text content
      if (content) {
        const contentDiv = document.createElement('div');
        contentDiv.innerHTML = formatContent(content);
        // Append children directly to avoid nesting issues
        while (contentDiv.firstChild) {
          div.appendChild(contentDiv.firstChild);
        }
      }

      messagesDiv.appendChild(div);
      return div;
    }

    function formatContent(text) {
      // Use marked for full markdown rendering
      if (typeof marked !== 'undefined') {
        marked.setOptions({
          breaks: true, // Convert \n to <br>
          gfm: true, // GitHub flavored markdown
        });
        return marked.parse(text);
      }
      // Fallback if marked isn't loaded
      return text.replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    function addTimestamp(date) {
      const div = document.createElement('div');
      div.className = 'timestamp';
      div.textContent = date;
      messagesDiv.appendChild(div);
    }

    function addTyping() {
      const div = document.createElement('div');
      div.className = 'typing';
      div.innerHTML = '<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';
      messagesDiv.appendChild(div);
      return div;
    }

    function addStatusIndicator(initialMessage) {
      const div = document.createElement('div');
      div.className = 'status-indicator';
      div.innerHTML = `
        <div class="status-spinner"></div>
        <div class="status-content">
          <div class="status-action">${escapeHtml(initialMessage)}</div>
          <div class="status-detail"></div>
        </div>
      `;
      messagesDiv.appendChild(div);
      return div;
    }

    function updateStatusIndicator(status) {
      if (!currentStatusEl) return;

      const actionEl = currentStatusEl.querySelector('.status-action');
      const detailEl = currentStatusEl.querySelector('.status-detail');

      if (status.type === 'thinking') {
        actionEl.textContent = status.message || 'hmm let me think 🤔';
        detailEl.textContent = '';
        detailEl.style.display = 'none';
        currentStatusEl.classList.remove('subagent-active');
      } else if (status.type === 'tool_start') {
        actionEl.textContent = status.toolName || 'doing something cool ✨';
        if (status.toolInput) {
          detailEl.textContent = status.toolInput;
          detailEl.title = status.toolInput;
          detailEl.style.display = 'block';
        } else {
          detailEl.textContent = '';
          detailEl.style.display = 'none';
        }
        currentStatusEl.classList.remove('subagent-active');
      } else if (status.type === 'tool_end') {
        actionEl.textContent = status.message || 'got it, thinking... 💭';
        detailEl.textContent = '';
        detailEl.style.display = 'none';
        currentStatusEl.classList.remove('subagent-active');
      } else if (status.type === 'subagent_start') {
        // Subagent spawned - show special status
        currentStatusEl.classList.add('subagent-active');
        actionEl.textContent = status.message || 'spawning helpers 🚀';
        if (status.toolInput) {
          const countBadge = status.agentCount > 1 ? ` (${status.agentCount} active)` : '';
          detailEl.textContent = status.toolInput + countBadge;
          detailEl.title = status.toolInput;
          detailEl.style.display = 'block';
        } else {
          detailEl.textContent = status.agentCount > 1 ? `${status.agentCount} helpers active` : '';
          detailEl.style.display = status.agentCount > 1 ? 'block' : 'none';
        }
      } else if (status.type === 'subagent_update') {
        // Multiple subagents, one finished
        actionEl.textContent = status.message || `${status.agentCount} helpers working 🔄`;
        detailEl.textContent = '';
        detailEl.style.display = 'none';
      } else if (status.type === 'subagent_end') {
        // All subagents done
        currentStatusEl.classList.remove('subagent-active');
        actionEl.textContent = status.message || 'helpers done ✨';
        detailEl.textContent = '';
        detailEl.style.display = 'none';
      } else if (status.type === 'responding') {
        actionEl.textContent = 'cooking up a response... 👨‍🍳';
        detailEl.textContent = '';
        detailEl.style.display = 'none';
        currentStatusEl.classList.remove('subagent-active');
      }

      scrollToBottom();
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function showEmptyState() {
      messagesDiv.innerHTML = `
        <div class="empty-state">
          <div class="empty-emoji">👋</div>
          <div class="empty-title">hey! what's up?</div>
          <div class="empty-subtitle">i remember everything, so just pick up where we left off ✨</div>
        </div>
      `;
    }

    function scrollToBottom(instant = false) {
      requestAnimationFrame(() => {
        messagesDiv.scrollTo({
          top: messagesDiv.scrollHeight,
          behavior: instant ? 'instant' : 'smooth'
        });
      });
    }

    function handleKeydown(e) {
      // Tab: Accept the suggestion and place cursor at end
      if (e.key === 'Tab' && currentSuggestion && !input.value.trim()) {
        e.preventDefault();
        acceptSuggestion();
        return;
      }

      // Enter: Send message (or suggestion if no user input)
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        // If there's a suggestion and no user input, send the suggestion
        if (currentSuggestion && !input.value.trim()) {
          input.value = currentSuggestion;
          clearSuggestion();
        }
        sendMessage();
        return;
      }

      // Escape: Clear the suggestion
      if (e.key === 'Escape' && currentSuggestion) {
        e.preventDefault();
        clearSuggestion();
        return;
      }
    }

    function handleInput(e) {
      // When user types, clear the suggestion
      if (currentSuggestion && input.value.trim()) {
        clearSuggestion();
      }
      autoResizeTextarea();
    }

    function setSuggestion(text) {
      if (!text) {
        clearSuggestion();
        return;
      }
      currentSuggestion = text;
      ghostSuggestion.innerHTML = escapeHtml(text) + '<span class="tab-hint">Tab to accept</span>';
      ghostSuggestion.style.display = 'block';
      input.classList.add('has-suggestion');
    }

    function clearSuggestion() {
      currentSuggestion = null;
      ghostSuggestion.innerHTML = '';
      ghostSuggestion.style.display = 'none';
      input.classList.remove('has-suggestion');
    }

    function acceptSuggestion() {
      if (!currentSuggestion) return;
      input.value = currentSuggestion;
      clearSuggestion();
      autoResizeTextarea();
      // Place cursor at the end
      input.focus();
      input.setSelectionRange(input.value.length, input.value.length);
    }

    function triggerAttach() {
      fileInput.click();
    }

    async function handleFileSelect(e) {
      const files = Array.from(e.target.files);
      if (files.length === 0) return;

      for (const file of files) {
        const ext = file.name.split('.').pop()?.toLowerCase() || '';

        // Validate extension
        if (!ALLOWED_EXTENSIONS.has(ext)) {
          addMessage('system', `Unsupported file type: ${file.name}`);
          continue;
        }

        // Validate size
        if (file.size > MAX_FILE_SIZE) {
          addMessage('system', `File too large (max 10MB): ${file.name}`);
          continue;
        }

        try {
          const attachment = await readFile(file, ext);
          pendingAttachments.push(attachment);
        } catch (err) {
          addMessage('system', `Failed to read file: ${file.name}`);
        }
      }

      // Reset file input and update UI
      fileInput.value = '';
      renderAttachmentPreviews();
      input.focus();
    }

    async function readFile(file, ext) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();

        reader.onload = (e) => {
          const attachment = {
            name: file.name,
            type: file.type,
            size: file.size,
            ext: ext,
            isImage: IMAGE_EXTENSIONS.has(ext),
          };

          if (attachment.isImage || ext === 'pdf') {
            // Store as data URL for images and PDFs
            attachment.dataUrl = e.target.result;
            attachment.content = null;
          } else {
            // Store as text for text files
            attachment.dataUrl = null;
            attachment.content = e.target.result;
          }

          resolve(attachment);
        };

        reader.onerror = () => reject(reader.error);

        if (IMAGE_EXTENSIONS.has(ext) || ext === 'pdf') {
          reader.readAsDataURL(file);
        } else {
          reader.readAsText(file);
        }
      });
    }

    function renderAttachmentPreviews() {
      // Remove existing container
      const existing = document.querySelector('.attachments-container');
      if (existing) existing.remove();

      if (pendingAttachments.length === 0) return;

      // Create container
      const container = document.createElement('div');
      container.className = 'attachments-container';

      pendingAttachments.forEach((att, index) => {
        const preview = document.createElement('div');
        preview.className = 'attachment-preview';

        if (att.isImage && att.dataUrl) {
          const img = document.createElement('img');
          img.src = att.dataUrl;
          img.alt = att.name;
          preview.innerHTML = `
            <div class="attachment-info">
              <div class="attachment-name">${escapeHtml(att.name)}</div>
              <div class="attachment-size">${formatFileSize(att.size)}</div>
            </div>
            <button class="attachment-remove" onclick="removeAttachment(${index})">×</button>
          `;
          preview.insertBefore(img, preview.firstChild);
        } else {
          preview.innerHTML = `
            <div class="attachment-icon">${att.ext}</div>
            <div class="attachment-info">
              <div class="attachment-name">${escapeHtml(att.name)}</div>
              <div class="attachment-size">${formatFileSize(att.size)}</div>
            </div>
            <button class="attachment-remove" onclick="removeAttachment(${index})">×</button>
          `;
        }

        container.appendChild(preview);
      });

      // Insert before input area
      const inputArea = document.getElementById('input-area');
      inputArea.parentNode.insertBefore(container, inputArea);
    }

    function removeAttachment(index) {
      pendingAttachments.splice(index, 1);
      renderAttachmentPreviews();
    }

    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    function clearAttachments() {
      pendingAttachments = [];
      renderAttachmentPreviews();
    }

    // Auto-resize textarea
    input.addEventListener('input', () => {
      input.style.height = 'auto';
      input.style.height = Math.min(input.scrollHeight, 150) + 'px';
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      // Cmd/Ctrl + K to clear
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault();
        clearChat();
      }
      // Cmd/Ctrl + , to open settings
      if ((e.metaKey || e.ctrlKey) && e.key === ',') {
        e.preventDefault();
        openSettings();
      }
    });

    async function openSettings() {
      try {
        await window.pocketAgent.openSettings();
      } catch (err) {
        console.error('Failed to open settings:', err);
      }
    }

    async function openFactsGraph() {
      try {
        await window.pocketAgent.openFactsGraph();
      } catch (err) {
        console.error('Failed to open facts graph:', err);
      }
    }

    async function openCustomize() {
      try {
        await window.pocketAgent.openCustomize();
      } catch (err) {
        console.error('Failed to open customize:', err);
      }
    }

    // Hamburger menu functions
    function toggleMenu() {
      const btn = document.getElementById('hamburger-btn');
      const dropdown = document.getElementById('menu-dropdown');
      const isOpen = dropdown.classList.contains('open');

      if (isOpen) {
        closeMenu();
      } else {
        btn.classList.add('active');
        dropdown.classList.add('open');
      }
    }

    function closeMenu() {
      const btn = document.getElementById('hamburger-btn');
      const dropdown = document.getElementById('menu-dropdown');
      btn.classList.remove('active');
      dropdown.classList.remove('open');
    }

    // Close menu when clicking outside
    document.addEventListener('click', (e) => {
      const menu = document.querySelector('.hamburger-menu');
      if (menu && !menu.contains(e.target)) {
        closeMenu();
      }
    });

    // Close menu on escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeMenu();
        closeDailyTasks();
      }
    });

    async function openRoutines() {
      try {
        await window.pocketAgent.openRoutines();
      } catch (err) {
        console.error('Failed to open routines:', err);
      }
    }
  </script>
</body>
</html>
