<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src https://fonts.gstatic.com; img-src 'self' data:;">
  <title>Pocket Agent</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Sora:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    :root {
      --bg-primary: #0a0a0b;
      --bg-secondary: #141415;
      --bg-tertiary: #1c1c1e;
      --border: #2a2a2d;
      --text-primary: #fafafa;
      --text-secondary: #a1a1a6;
      --text-muted: #636366;
      --accent: #6366f1;
      --accent-hover: #818cf8;
      --user-bubble: #6366f1;
      --assistant-bubble: #1c1c1e;
      --error: #ef4444;
      --success: #22c55e;
      --radius: 16px;
      --radius-sm: 8px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Sora', -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Segoe UI', system-ui, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      -webkit-font-smoothing: antialiased;
    }

    /* Header */
    header {
      background: var(--bg-secondary);
      padding: 16px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--success);
      box-shadow: 0 0 8px var(--success);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    header h1 {
      font-family: 'Sora', sans-serif;
      font-size: 16px;
      font-weight: 700;
      letter-spacing: -0.02em;
    }

    .stats {
      font-size: 12px;
      color: var(--text-muted);
      font-weight: 500;
    }

    /* Toolbar */
    .toolbar {
      display: flex;
      gap: 6px;
      padding: 10px 20px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }

    .toolbar button {
      padding: 6px 12px;
      background: var(--bg-tertiary);
      color: var(--text-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      transition: all 0.15s ease;
    }

    .toolbar button:hover {
      background: var(--border);
      color: var(--text-primary);
    }

    /* Messages Container */
    #messages {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      scroll-behavior: smooth;
    }

    #messages::-webkit-scrollbar {
      width: 6px;
    }

    #messages::-webkit-scrollbar-track {
      background: transparent;
    }

    #messages::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 3px;
    }

    #messages::-webkit-scrollbar-thumb:hover {
      background: var(--text-muted);
    }

    /* Message Bubbles */
    .message {
      max-width: 80%;
      padding: 12px 16px;
      border-radius: var(--radius);
      line-height: 1.5;
      font-size: 14px;
      word-wrap: break-word;
      animation: messageIn 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      transform-origin: bottom;
    }

    @keyframes messageIn {
      from {
        opacity: 0;
        transform: translateY(10px) scale(0.98);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .message.user {
      align-self: flex-end;
      background: var(--user-bubble);
      color: white;
      border-bottom-right-radius: 4px;
    }

    .message.assistant {
      align-self: flex-start;
      background: var(--assistant-bubble);
      border: 1px solid var(--border);
      border-bottom-left-radius: 4px;
      color: var(--text-primary);
    }

    .message.system {
      align-self: center;
      background: transparent;
      color: var(--text-muted);
      font-size: 13px;
      padding: 8px 16px;
    }

    .message.reminder {
      align-self: flex-start;
      background: var(--assistant-bubble);
      border: 1px solid var(--accent);
      border-left: 3px solid var(--accent);
      color: var(--text-primary);
    }

    .reminder-header {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: var(--accent);
      margin-bottom: 6px;
      font-weight: 500;
    }

    .reminder-header svg {
      width: 14px;
      height: 14px;
      flex-shrink: 0;
    }

    .telegram-header {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: #0088cc;
      margin-bottom: 6px;
      font-weight: 500;
      opacity: 0.9;
    }

    .telegram-header svg {
      width: 14px;
      height: 14px;
      flex-shrink: 0;
    }

    .message.error {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: var(--error);
    }

    /* Code blocks in messages */
    .message code {
      background: rgba(0, 0, 0, 0.3);
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
      font-size: 13px;
    }

    .message pre {
      background: rgba(0, 0, 0, 0.4);
      padding: 12px;
      border-radius: var(--radius-sm);
      overflow-x: auto;
      margin: 8px 0;
    }

    .message pre code {
      background: none;
      padding: 0;
    }

    /* Markdown elements - tight spacing for chat */
    .message h1, .message h2, .message h3, .message h4 {
      margin: 1em 0 0.4em 0;
      font-weight: 600;
      line-height: 1.3;
    }

    .message h1:first-child, .message h2:first-child,
    .message h3:first-child, .message h4:first-child {
      margin-top: 0;
    }

    .message h1 { font-size: 1.2em; }
    .message h2 { font-size: 1.1em; }
    .message h3 { font-size: 1.05em; }
    .message h4 { font-size: 1em; }

    .message p {
      margin: 0;
    }

    .message p + p {
      margin-top: 0.5em;
    }

    .message > *:last-child {
      margin-bottom: 0 !important;
    }

    .message > *:first-child {
      margin-top: 0 !important;
    }

    .message ul, .message ol {
      margin: 0.3em 0;
      padding-left: 1.4em;
    }

    .message ul:first-child, .message ol:first-child { margin-top: 0; }
    .message ul:last-child, .message ol:last-child { margin-bottom: 0; }

    .message li {
      margin: 0;
      padding: 0;
      line-height: 1.5;
    }

    .message li + li {
      margin-top: 0.1em;
    }

    .message li p,
    .message li > p,
    .message li p:first-child,
    .message li p:last-child {
      margin: 0;
      padding: 0;
      display: inline;
    }

    .message a {
      color: #60a5fa;
      text-decoration: underline;
      text-decoration-color: rgba(96, 165, 250, 0.4);
      text-underline-offset: 2px;
    }

    .message a:hover {
      color: #93c5fd;
      text-decoration-color: rgba(147, 197, 253, 0.6);
    }

    .message.user a {
      color: #bfdbfe;
      text-decoration-color: rgba(191, 219, 254, 0.4);
    }

    .message.user a:hover {
      color: #ffffff;
      text-decoration-color: rgba(255, 255, 255, 0.6);
    }

    .message hr {
      border: none;
      border-top: 1px solid var(--border);
      margin: 0.6em 0;
    }

    .message blockquote {
      border-left: 3px solid var(--accent);
      padding-left: 0.8em;
      margin: 0.4em 0;
      color: var(--text-secondary);
    }

    .message table {
      border-collapse: collapse;
      margin: 0.5em 0;
      width: 100%;
      font-size: 0.95em;
    }

    .message th, .message td {
      border: 1px solid var(--border);
      padding: 0.4em 0.6em;
      text-align: left;
    }

    .message th {
      background: var(--bg-tertiary);
    }

    .message strong { font-weight: 600; }
    .message em { font-style: italic; }

    /* Status Indicator */
    .status-indicator {
      align-self: flex-start;
      padding: 10px 14px;
      background: var(--assistant-bubble);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      border-bottom-left-radius: 4px;
      display: flex;
      align-items: center;
      gap: 10px;
      animation: messageIn 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      max-width: 80%;
    }

    .status-spinner {
      width: 16px;
      height: 16px;
      border: 2px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      flex-shrink: 0;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .status-content {
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
    }

    .status-action {
      font-size: 13px;
      font-weight: 500;
      background: linear-gradient(
        90deg,
        var(--text-primary) 0%,
        var(--accent) 25%,
        var(--text-primary) 50%,
        var(--accent) 75%,
        var(--text-primary) 100%
      );
      background-size: 200% 100%;
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: shimmer 2s ease-in-out infinite;
    }

    @keyframes shimmer {
      0% { background-position: 100% 0; }
      100% { background-position: -100% 0; }
    }

    /* Subagent active state - purple/pink vibe */
    .status-indicator.subagent-active {
      border-color: #a855f7;
      background: linear-gradient(135deg, rgba(168, 85, 247, 0.1) 0%, rgba(236, 72, 153, 0.1) 100%);
    }

    .status-indicator.subagent-active .status-spinner {
      border-color: rgba(168, 85, 247, 0.3);
      border-top-color: #a855f7;
    }

    .status-indicator.subagent-active .status-action {
      background: linear-gradient(
        90deg,
        #a855f7 0%,
        #ec4899 25%,
        #a855f7 50%,
        #ec4899 75%,
        #a855f7 100%
      );
      background-size: 200% 100%;
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: shimmer 1.5s ease-in-out infinite;
    }

    .status-detail {
      font-size: 12px;
      color: var(--text-muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
    }

    /* Simple typing dots fallback */
    .typing {
      align-self: flex-start;
      padding: 12px 16px;
      background: var(--assistant-bubble);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      border-bottom-left-radius: 4px;
      display: flex;
      gap: 4px;
      animation: messageIn 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    }

    .typing-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--text-muted);
      animation: typingBounce 1.4s infinite ease-in-out both;
    }

    .typing-dot:nth-child(1) { animation-delay: -0.32s; }
    .typing-dot:nth-child(2) { animation-delay: -0.16s; }
    .typing-dot:nth-child(3) { animation-delay: 0s; }

    @keyframes typingBounce {
      0%, 80%, 100% {
        transform: scale(0.8);
        opacity: 0.5;
      }
      40% {
        transform: scale(1);
        opacity: 1;
      }
    }

    /* Input Area */
    #input-area {
      padding: 16px 20px 20px 20px;
      background: var(--bg-secondary);
      border-top: 1px solid var(--border);
      display: flex;
      gap: 12px;
      align-items: flex-end;
      flex-shrink: 0;
    }

    .input-container {
      flex: 1;
      display: flex;
      align-items: flex-end;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 4px;
      transition: border-color 0.15s ease, box-shadow 0.15s ease;
    }

    .input-container:focus-within {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    .attach-btn {
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: none;
      border-radius: var(--radius-sm);
      cursor: pointer;
      color: var(--text-muted);
      transition: all 0.15s ease;
      flex-shrink: 0;
    }

    .attach-btn:hover {
      background: var(--border);
      color: var(--text-primary);
    }

    .attach-btn svg {
      width: 18px;
      height: 18px;
    }

    #message-input {
      flex: 1;
      padding: 8px 12px;
      border: none;
      background: transparent;
      color: var(--text-primary);
      font-size: 14px;
      font-family: inherit;
      outline: none;
      resize: none;
      min-height: 24px;
      max-height: 150px;
      line-height: 1.5;
      position: relative;
      z-index: 1;
    }

    #message-input::placeholder {
      color: var(--text-muted);
    }

    #message-input.has-suggestion::placeholder {
      color: transparent;
    }

    .textarea-wrapper {
      position: relative;
      flex: 1;
      display: flex;
    }

    #ghost-suggestion {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      padding: 8px 12px;
      font-size: 14px;
      font-family: inherit;
      line-height: 1.5;
      color: var(--text-muted);
      pointer-events: none;
      white-space: pre-wrap;
      word-wrap: break-word;
      opacity: 0.6;
    }

    #ghost-suggestion .tab-hint {
      color: var(--accent);
      opacity: 0.7;
      font-size: 12px;
      margin-left: 8px;
    }

    #send-btn {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.15s ease;
      flex-shrink: 0;
    }

    #send-btn:hover:not(:disabled) {
      background: var(--accent-hover);
      transform: scale(1.02);
    }

    #send-btn:active:not(:disabled) {
      transform: scale(0.98);
    }

    #send-btn:disabled {
      background: var(--bg-tertiary);
      color: var(--text-muted);
      cursor: not-allowed;
    }

    #send-btn svg {
      width: 18px;
      height: 18px;
    }

    #send-btn.stop-btn {
      background: var(--error);
    }

    #send-btn.stop-btn:hover {
      background: #dc2626;
    }

    /* Empty State */
    .empty-state {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
      gap: 12px;
      padding: 40px;
      animation: fadeIn 0.5s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .empty-state svg {
      width: 48px;
      height: 48px;
      opacity: 0.5;
    }

    .empty-state p {
      font-size: 14px;
      text-align: center;
    }

    /* Timestamp */
    .timestamp {
      font-size: 11px;
      color: var(--text-muted);
      text-align: center;
      padding: 8px 0;
    }

    /* File Input (hidden) */
    #file-input {
      display: none;
    }

    /* Attachments */
    .attachments-container {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      padding: 8px 12px;
      background: var(--bg-tertiary);
      border-top: 1px solid var(--border);
      max-height: 120px;
      overflow-y: auto;
    }

    .attachment-preview {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      font-size: 12px;
      color: var(--text-secondary);
      max-width: 200px;
    }

    .attachment-preview img {
      width: 32px;
      height: 32px;
      object-fit: cover;
      border-radius: 4px;
    }

    .attachment-icon {
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-tertiary);
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      flex-shrink: 0;
    }

    .attachment-info {
      flex: 1;
      min-width: 0;
      overflow: hidden;
    }

    .attachment-name {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      color: var(--text-primary);
    }

    .attachment-size {
      font-size: 11px;
      color: var(--text-muted);
    }

    .attachment-remove {
      width: 18px;
      height: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      color: var(--text-muted);
      font-size: 14px;
      line-height: 1;
      flex-shrink: 0;
    }

    .attachment-remove:hover {
      background: var(--border);
      color: var(--error);
    }

    /* Attachment in messages */
    .message-attachments {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 8px;
    }

    .message-attachment {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 6px;
      font-size: 12px;
    }

    .message-attachment img {
      max-width: 200px;
      max-height: 150px;
      border-radius: 6px;
    }
  </style>
</head>
<body>
  <header>
    <div class="header-left">
      <div class="status-dot"></div>
      <h1>Pocket Agent</h1>
    </div>
    <div class="stats" id="stats"></div>
  </header>

  <div class="toolbar">
    <button onclick="clearChat()">Clear</button>
    <button onclick="showFacts()">Facts</button>
    <button onclick="openFactsGraph()" title="Open Knowledge Graph">
      <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;">
        <circle cx="6" cy="6" r="3"/>
        <circle cx="18" cy="6" r="3"/>
        <circle cx="6" cy="18" r="3"/>
        <circle cx="18" cy="18" r="3"/>
        <line x1="8.5" y1="7.5" x2="15.5" y2="16.5"/>
        <line x1="15.5" y1="7.5" x2="8.5" y2="16.5"/>
      </svg>
      Graph
    </button>
    <button onclick="openCustomize()" title="Customize Agent">
      <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;">
        <path d="M12 20h9"/>
        <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/>
      </svg>
      Customize
    </button>
    <div style="flex: 1;"></div>
    <button onclick="openSettings()" title="Settings">
      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle;"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
    </button>
  </div>

  <div id="messages"></div>

  <div id="input-area">
    <div class="input-container">
      <button class="attach-btn" onclick="triggerAttach()" title="Attach file">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21.44 11.05l-9.19 9.19a6 6 0 01-8.49-8.49l9.19-9.19a4 4 0 015.66 5.66l-9.2 9.19a2 2 0 01-2.83-2.83l8.49-8.48"/>
        </svg>
      </button>
      <div class="textarea-wrapper">
        <div id="ghost-suggestion"></div>
        <textarea
          id="message-input"
          placeholder="Message Pocket Agent..."
          rows="1"
          onkeydown="handleKeydown(event)"
          oninput="handleInput(event)"
        ></textarea>
      </div>
    </div>
    <button id="send-btn" onclick="handleSendClick()" title="Send message">
      <svg class="send-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <line x1="22" y1="2" x2="11" y2="13"/>
        <polygon points="22 2 15 22 11 13 2 9 22 2"/>
      </svg>
      <svg class="stop-icon" style="display: none;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
        <rect x="6" y="6" width="12" height="12" rx="2"/>
      </svg>
    </button>
  </div>

  <input type="file" id="file-input" onchange="handleFileSelect(event)" multiple
    accept=".txt,.md,.json,.csv,.xml,.html,.htm,.css,.js,.ts,.jsx,.tsx,.py,.rb,.go,.rs,.java,.c,.cpp,.h,.hpp,.sh,.yaml,.yml,.toml,.ini,.cfg,.conf,.log,.sql,.graphql,.pdf,.png,.jpg,.jpeg,.gif,.webp,.svg,.bmp,.ico">

  <script>
    const messagesDiv = document.getElementById('messages');
    const input = document.getElementById('message-input');
    const sendBtn = document.getElementById('send-btn');
    const statsDiv = document.getElementById('stats');
    const fileInput = document.getElementById('file-input');

    let isLoading = false;
    let pendingAttachments = []; // { file, name, type, size, dataUrl, content }
    let statusCleanup = null;
    let currentStatusEl = null;
    let currentSuggestion = null; // Stores the suggested prompt from the agent
    const ghostSuggestion = document.getElementById('ghost-suggestion');

    // Allowed file types
    const ALLOWED_EXTENSIONS = new Set([
      // Text/Code
      'txt', 'md', 'json', 'csv', 'xml', 'html', 'htm', 'css', 'js', 'ts', 'jsx', 'tsx',
      'py', 'rb', 'go', 'rs', 'java', 'c', 'cpp', 'h', 'hpp', 'sh', 'yaml', 'yml',
      'toml', 'ini', 'cfg', 'conf', 'log', 'sql', 'graphql',
      // Images
      'png', 'jpg', 'jpeg', 'gif', 'webp', 'svg', 'bmp', 'ico',
      // Documents
      'pdf'
    ]);

    const IMAGE_EXTENSIONS = new Set(['png', 'jpg', 'jpeg', 'gif', 'webp', 'svg', 'bmp', 'ico']);
    const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB

    // Initialize
    window.addEventListener('DOMContentLoaded', () => {
      loadHistory();
      updateStats();
      input.focus();

      // Listen for scheduler messages
      window.pocketAgent.onSchedulerMessage((data) => {
        console.log('[Chat] Received scheduler message:', data.jobName);
        handleSchedulerMessage(data);
      });

      // Listen for Telegram messages (cross-channel sync)
      console.log('[Chat] Setting up Telegram message listener');
      window.pocketAgent.onTelegramMessage((data) => {
        console.log('[Chat] Received Telegram message:', data);
        handleTelegramMessage(data);
      });
      console.log('[Chat] Telegram message listener set up');
    });

    function handleSchedulerMessage(data) {
      // Clear empty state if present
      const emptyState = messagesDiv.querySelector('.empty-state');
      if (emptyState) emptyState.remove();

      // Use the shared reminder rendering function
      addReminderFromHistory(data.jobName, data.prompt, true);

      // Add the agent's response
      addMessage('assistant', data.response);

      // Update stats and scroll
      updateStats();
      scrollToBottom();

      // Focus window
      window.focus();
    }

    function handleTelegramMessage(data) {
      // Clear empty state if present
      const emptyState = messagesDiv.querySelector('.empty-state');
      if (emptyState) emptyState.remove();

      // Add Telegram indicator + user message
      addTelegramMessage('user', data.userMessage);

      // Add the agent's response
      addMessage('assistant', data.response);

      // Update stats and scroll
      updateStats();
      scrollToBottom();
    }

    function addTelegramMessage(role, content) {
      const wrapper = document.createElement('div');
      wrapper.className = `message ${role}`;

      // Telegram icon SVG
      const telegramIcon = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="14" height="14"><path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/></svg>`;

      const header = document.createElement('div');
      header.className = 'telegram-header';
      header.innerHTML = `${telegramIcon} <span>via Telegram</span>`;

      const contentDiv = document.createElement('div');
      contentDiv.className = 'message-content';
      contentDiv.innerHTML = formatMessage(content);

      wrapper.appendChild(header);
      wrapper.appendChild(contentDiv);
      messagesDiv.appendChild(wrapper);

      return wrapper;
    }

    function addReminderFromHistory(jobName, prompt, animate = true) {
      // Create reminder message with icon
      const reminderDiv = document.createElement('div');
      reminderDiv.className = 'message reminder';
      if (!animate) reminderDiv.style.animation = 'none';

      const promptPreview = prompt.length > 100
        ? prompt.slice(0, 100) + '...'
        : prompt;

      // Clock icon SVG
      const clockIcon = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>`;

      reminderDiv.innerHTML = `
        <div class="reminder-header">
          ${clockIcon}
          <span>Scheduled: ${escapeHtml(jobName)}</span>
        </div>
        <div class="reminder-content">${escapeHtml(promptPreview)}</div>
      `;

      messagesDiv.appendChild(reminderDiv);
      return reminderDiv;
    }

    async function loadHistory() {
      try {
        const history = await window.pocketAgent.getHistory(100);
        messagesDiv.innerHTML = '';

        if (history.length === 0) {
          showEmptyState();
        } else {
          let lastDate = null;
          for (let i = 0; i < history.length; i++) {
            const msg = history[i];
            // Add date separator if needed
            const msgDate = new Date(msg.timestamp).toLocaleDateString();
            if (msgDate !== lastDate) {
              addTimestamp(msgDate);
              lastDate = msgDate;
            }

            // Check if this is a scheduled reminder (user message starts with [Scheduled: ...])
            if (msg.role === 'user' && msg.content.startsWith('[Scheduled:')) {
              // Extract job name and prompt from [Scheduled: jobname] prompt
              const match = msg.content.match(/^\[Scheduled:\s*([^\]]+)\]\s*(.*)/s);
              if (match) {
                const jobName = match[1];
                const prompt = match[2];

                // Render as reminder
                addReminderFromHistory(jobName, prompt, false);

                // The next message should be the assistant's response
                if (i + 1 < history.length && history[i + 1].role === 'assistant') {
                  addMessage('assistant', history[i + 1].content, false);
                  i++; // Skip the next message since we've handled it
                }
                continue;
              }
            }

            addMessage(msg.role, msg.content, false);
          }
        }

        scrollToBottom(true); // Instant scroll on initial load
      } catch (err) {
        console.error('Failed to load history:', err);
        showEmptyState();
      }
    }

    async function updateStats() {
      try {
        const stats = await window.pocketAgent.getStats();
        if (stats) {
          const tokens = stats.estimatedTokens >= 1000
            ? `${(stats.estimatedTokens / 1000).toFixed(1)}k`
            : stats.estimatedTokens;
          statsDiv.textContent = `${stats.messageCount} messages ¬∑ ${stats.factCount} facts ¬∑ ${tokens} tokens`;
        }
      } catch (err) {
        console.error('Failed to get stats:', err);
      }
    }

    function handleSendClick() {
      if (isLoading) {
        stopQuery();
      } else {
        sendMessage();
      }
    }

    function setButtonState(loading) {
      const sendIcon = sendBtn.querySelector('.send-icon');
      const stopIcon = sendBtn.querySelector('.stop-icon');

      if (loading) {
        sendBtn.classList.add('stop-btn');
        sendBtn.title = 'Stop';
        sendIcon.style.display = 'none';
        stopIcon.style.display = 'block';
        sendBtn.disabled = false;
      } else {
        sendBtn.classList.remove('stop-btn');
        sendBtn.title = 'Send message';
        sendIcon.style.display = 'block';
        stopIcon.style.display = 'none';
      }
    }

    async function stopQuery() {
      try {
        await window.pocketAgent.stop();

        // Clean up status listener
        if (statusCleanup) {
          statusCleanup();
          statusCleanup = null;
        }

        // Remove status indicator
        if (currentStatusEl) {
          currentStatusEl.remove();
          currentStatusEl = null;
        }

        addMessage('system', 'Query stopped.');

        isLoading = false;
        setButtonState(false);
        scrollToBottom();
        input.focus();
      } catch (err) {
        console.error('Failed to stop query:', err);
      }
    }

    async function sendMessage() {
      const message = input.value.trim();
      const attachments = [...pendingAttachments];

      if ((!message && attachments.length === 0) || isLoading) return;

      // Clear empty state if present
      const emptyState = messagesDiv.querySelector('.empty-state');
      if (emptyState) emptyState.remove();

      isLoading = true;
      setButtonState(true);
      input.value = '';
      input.style.height = 'auto';
      clearSuggestion();

      // Clear attachments
      clearAttachments();

      // Show user message with attachments
      addMessage('user', message, true, attachments);
      currentStatusEl = addStatusIndicator('hmm let me think ü§î');
      scrollToBottom();

      // Build the full message with attachments
      const fullMessage = await buildMessageWithAttachments(message, attachments);

      // Set up status listener
      statusCleanup = window.pocketAgent.onStatus((status) => {
        updateStatusIndicator(status);
      });

      try {
        const result = await window.pocketAgent.send(fullMessage);

        // Clean up status listener
        if (statusCleanup) {
          statusCleanup();
          statusCleanup = null;
        }

        // Remove status indicator
        if (currentStatusEl) {
          currentStatusEl.remove();
          currentStatusEl = null;
        }

        if (result.success) {
          addMessage('assistant', result.response);

          // If there's a suggested prompt, show it as ghost text
          if (result.suggestedPrompt) {
            setSuggestion(result.suggestedPrompt);
          }
        } else {
          addMessage('error', result.error);
        }

        updateStats();
      } catch (err) {
        // Clean up status listener
        if (statusCleanup) {
          statusCleanup();
          statusCleanup = null;
        }

        if (currentStatusEl) {
          currentStatusEl.remove();
          currentStatusEl = null;
        }

        // Don't show error if query was stopped
        if (!err.message?.includes('stopped')) {
          addMessage('error', err.message || 'Something went wrong');
        }
      }

      isLoading = false;
      setButtonState(false);
      scrollToBottom();
      input.focus();
    }

    async function buildMessageWithAttachments(message, attachments) {
      if (attachments.length === 0) return message;

      const parts = [];

      // Add text message if present
      if (message) {
        parts.push(message);
      }

      // Add attachments
      for (const att of attachments) {
        if (att.isImage && att.dataUrl) {
          // Save image to temp file and reference path
          try {
            const filePath = await window.pocketAgent.saveAttachment(att.name, att.dataUrl);
            parts.push(`\n\n[Attached image: ${att.name}]\nFile saved at: ${filePath}\nUse the Read tool to view this image.`);
          } catch (err) {
            parts.push(`\n\n[Image: ${att.name}] (failed to save: ${err.message})`);
          }
        } else if (att.ext === 'pdf' && att.dataUrl) {
          // Save PDF to temp file and reference path
          try {
            const filePath = await window.pocketAgent.saveAttachment(att.name, att.dataUrl);
            parts.push(`\n\n[Attached PDF: ${att.name}]\nFile saved at: ${filePath}\nUse the Read tool to view this PDF.`);
          } catch (err) {
            parts.push(`\n\n[PDF: ${att.name}] (failed to save: ${err.message})`);
          }
        } else if (att.content) {
          // For text files, include content directly (truncate if very large)
          const content = att.content.length > 50000
            ? att.content.slice(0, 50000) + '\n... (truncated)'
            : att.content;
          parts.push(`\n\n[File: ${att.name}]\n\`\`\`${att.ext}\n${content}\n\`\`\``);
        }
      }

      return parts.join('');
    }

    async function clearChat() {
      if (!confirm('Clear conversation history? Your saved facts will be preserved.')) return;

      try {
        await window.pocketAgent.clearConversation();
        messagesDiv.innerHTML = '';
        showEmptyState();
        updateStats();
      } catch (err) {
        addMessage('error', err.message);
      }
    }

    async function showFacts() {
      try {
        await window.pocketAgent.openFacts();
      } catch (err) {
        console.error('Failed to open facts:', err);
      }
    }

    function addMessage(role, content, animate = true, attachments = []) {
      const div = document.createElement('div');
      div.className = `message ${role}`;
      if (!animate) div.style.animation = 'none';

      // Add attachments display for user messages
      if (attachments && attachments.length > 0) {
        const attDiv = document.createElement('div');
        attDiv.className = 'message-attachments';

        for (const att of attachments) {
          const attItem = document.createElement('div');
          attItem.className = 'message-attachment';

          if (att.isImage && att.dataUrl) {
            const img = document.createElement('img');
            img.src = att.dataUrl;
            img.alt = att.name;
            attItem.appendChild(img);
          } else {
            attItem.innerHTML = `<span class="attachment-icon">${escapeHtml(att.ext)}</span> ${escapeHtml(att.name)}`;
          }

          attDiv.appendChild(attItem);
        }

        div.appendChild(attDiv);
      }

      // Add text content
      if (content) {
        const contentDiv = document.createElement('div');
        contentDiv.innerHTML = formatContent(content);
        // Append children directly to avoid nesting issues
        while (contentDiv.firstChild) {
          div.appendChild(contentDiv.firstChild);
        }
      }

      messagesDiv.appendChild(div);
      return div;
    }

    function formatContent(text) {
      // Use marked for full markdown rendering
      if (typeof marked !== 'undefined') {
        marked.setOptions({
          breaks: true, // Convert \n to <br>
          gfm: true, // GitHub flavored markdown
        });
        return marked.parse(text);
      }
      // Fallback if marked isn't loaded
      return text.replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    function addTimestamp(date) {
      const div = document.createElement('div');
      div.className = 'timestamp';
      div.textContent = date;
      messagesDiv.appendChild(div);
    }

    function addTyping() {
      const div = document.createElement('div');
      div.className = 'typing';
      div.innerHTML = '<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';
      messagesDiv.appendChild(div);
      return div;
    }

    function addStatusIndicator(initialMessage) {
      const div = document.createElement('div');
      div.className = 'status-indicator';
      div.innerHTML = `
        <div class="status-spinner"></div>
        <div class="status-content">
          <div class="status-action">${escapeHtml(initialMessage)}</div>
          <div class="status-detail"></div>
        </div>
      `;
      messagesDiv.appendChild(div);
      return div;
    }

    function updateStatusIndicator(status) {
      if (!currentStatusEl) return;

      const actionEl = currentStatusEl.querySelector('.status-action');
      const detailEl = currentStatusEl.querySelector('.status-detail');

      if (status.type === 'thinking') {
        actionEl.textContent = status.message || 'hmm let me think ü§î';
        detailEl.textContent = '';
        detailEl.style.display = 'none';
        currentStatusEl.classList.remove('subagent-active');
      } else if (status.type === 'tool_start') {
        actionEl.textContent = status.toolName || 'doing something cool ‚ú®';
        if (status.toolInput) {
          detailEl.textContent = status.toolInput;
          detailEl.title = status.toolInput;
          detailEl.style.display = 'block';
        } else {
          detailEl.textContent = '';
          detailEl.style.display = 'none';
        }
        currentStatusEl.classList.remove('subagent-active');
      } else if (status.type === 'tool_end') {
        actionEl.textContent = status.message || 'got it, thinking... üí≠';
        detailEl.textContent = '';
        detailEl.style.display = 'none';
        currentStatusEl.classList.remove('subagent-active');
      } else if (status.type === 'subagent_start') {
        // Subagent spawned - show special status
        currentStatusEl.classList.add('subagent-active');
        actionEl.textContent = status.message || 'spawning helpers üöÄ';
        if (status.toolInput) {
          const countBadge = status.agentCount > 1 ? ` (${status.agentCount} active)` : '';
          detailEl.textContent = status.toolInput + countBadge;
          detailEl.title = status.toolInput;
          detailEl.style.display = 'block';
        } else {
          detailEl.textContent = status.agentCount > 1 ? `${status.agentCount} helpers active` : '';
          detailEl.style.display = status.agentCount > 1 ? 'block' : 'none';
        }
      } else if (status.type === 'subagent_update') {
        // Multiple subagents, one finished
        actionEl.textContent = status.message || `${status.agentCount} helpers working üîÑ`;
        detailEl.textContent = '';
        detailEl.style.display = 'none';
      } else if (status.type === 'subagent_end') {
        // All subagents done
        currentStatusEl.classList.remove('subagent-active');
        actionEl.textContent = status.message || 'helpers done ‚ú®';
        detailEl.textContent = '';
        detailEl.style.display = 'none';
      } else if (status.type === 'responding') {
        actionEl.textContent = 'cooking up a response... üë®‚Äçüç≥';
        detailEl.textContent = '';
        detailEl.style.display = 'none';
        currentStatusEl.classList.remove('subagent-active');
      }

      scrollToBottom();
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function showEmptyState() {
      messagesDiv.innerHTML = `
        <div class="empty-state">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
          </svg>
          <p>Start a conversation with your AI assistant.<br>I remember everything across sessions.</p>
        </div>
      `;
    }

    function scrollToBottom(instant = false) {
      requestAnimationFrame(() => {
        messagesDiv.scrollTo({
          top: messagesDiv.scrollHeight,
          behavior: instant ? 'instant' : 'smooth'
        });
      });
    }

    function handleKeydown(e) {
      // Tab: Accept the suggestion and place cursor at end
      if (e.key === 'Tab' && currentSuggestion && !input.value.trim()) {
        e.preventDefault();
        acceptSuggestion();
        return;
      }

      // Enter: Send message (or suggestion if no user input)
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        // If there's a suggestion and no user input, send the suggestion
        if (currentSuggestion && !input.value.trim()) {
          input.value = currentSuggestion;
          clearSuggestion();
        }
        sendMessage();
        return;
      }

      // Escape: Clear the suggestion
      if (e.key === 'Escape' && currentSuggestion) {
        e.preventDefault();
        clearSuggestion();
        return;
      }
    }

    function handleInput(e) {
      // When user types, clear the suggestion
      if (currentSuggestion && input.value.trim()) {
        clearSuggestion();
      }
      autoResizeTextarea();
    }

    function setSuggestion(text) {
      if (!text) {
        clearSuggestion();
        return;
      }
      currentSuggestion = text;
      ghostSuggestion.innerHTML = escapeHtml(text) + '<span class="tab-hint">Tab to accept</span>';
      ghostSuggestion.style.display = 'block';
      input.classList.add('has-suggestion');
    }

    function clearSuggestion() {
      currentSuggestion = null;
      ghostSuggestion.innerHTML = '';
      ghostSuggestion.style.display = 'none';
      input.classList.remove('has-suggestion');
    }

    function acceptSuggestion() {
      if (!currentSuggestion) return;
      input.value = currentSuggestion;
      clearSuggestion();
      autoResizeTextarea();
      // Place cursor at the end
      input.focus();
      input.setSelectionRange(input.value.length, input.value.length);
    }

    function triggerAttach() {
      fileInput.click();
    }

    async function handleFileSelect(e) {
      const files = Array.from(e.target.files);
      if (files.length === 0) return;

      for (const file of files) {
        const ext = file.name.split('.').pop()?.toLowerCase() || '';

        // Validate extension
        if (!ALLOWED_EXTENSIONS.has(ext)) {
          addMessage('system', `Unsupported file type: ${file.name}`);
          continue;
        }

        // Validate size
        if (file.size > MAX_FILE_SIZE) {
          addMessage('system', `File too large (max 10MB): ${file.name}`);
          continue;
        }

        try {
          const attachment = await readFile(file, ext);
          pendingAttachments.push(attachment);
        } catch (err) {
          addMessage('system', `Failed to read file: ${file.name}`);
        }
      }

      // Reset file input and update UI
      fileInput.value = '';
      renderAttachmentPreviews();
      input.focus();
    }

    async function readFile(file, ext) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();

        reader.onload = (e) => {
          const attachment = {
            name: file.name,
            type: file.type,
            size: file.size,
            ext: ext,
            isImage: IMAGE_EXTENSIONS.has(ext),
          };

          if (attachment.isImage || ext === 'pdf') {
            // Store as data URL for images and PDFs
            attachment.dataUrl = e.target.result;
            attachment.content = null;
          } else {
            // Store as text for text files
            attachment.dataUrl = null;
            attachment.content = e.target.result;
          }

          resolve(attachment);
        };

        reader.onerror = () => reject(reader.error);

        if (IMAGE_EXTENSIONS.has(ext) || ext === 'pdf') {
          reader.readAsDataURL(file);
        } else {
          reader.readAsText(file);
        }
      });
    }

    function renderAttachmentPreviews() {
      // Remove existing container
      const existing = document.querySelector('.attachments-container');
      if (existing) existing.remove();

      if (pendingAttachments.length === 0) return;

      // Create container
      const container = document.createElement('div');
      container.className = 'attachments-container';

      pendingAttachments.forEach((att, index) => {
        const preview = document.createElement('div');
        preview.className = 'attachment-preview';

        if (att.isImage && att.dataUrl) {
          const img = document.createElement('img');
          img.src = att.dataUrl;
          img.alt = att.name;
          preview.innerHTML = `
            <div class="attachment-info">
              <div class="attachment-name">${escapeHtml(att.name)}</div>
              <div class="attachment-size">${formatFileSize(att.size)}</div>
            </div>
            <button class="attachment-remove" onclick="removeAttachment(${index})">√ó</button>
          `;
          preview.insertBefore(img, preview.firstChild);
        } else {
          preview.innerHTML = `
            <div class="attachment-icon">${att.ext}</div>
            <div class="attachment-info">
              <div class="attachment-name">${escapeHtml(att.name)}</div>
              <div class="attachment-size">${formatFileSize(att.size)}</div>
            </div>
            <button class="attachment-remove" onclick="removeAttachment(${index})">√ó</button>
          `;
        }

        container.appendChild(preview);
      });

      // Insert before input area
      const inputArea = document.getElementById('input-area');
      inputArea.parentNode.insertBefore(container, inputArea);
    }

    function removeAttachment(index) {
      pendingAttachments.splice(index, 1);
      renderAttachmentPreviews();
    }

    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    function clearAttachments() {
      pendingAttachments = [];
      renderAttachmentPreviews();
    }

    // Auto-resize textarea
    input.addEventListener('input', () => {
      input.style.height = 'auto';
      input.style.height = Math.min(input.scrollHeight, 150) + 'px';
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      // Cmd/Ctrl + K to clear
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault();
        clearChat();
      }
      // Cmd/Ctrl + , to open settings
      if ((e.metaKey || e.ctrlKey) && e.key === ',') {
        e.preventDefault();
        openSettings();
      }
    });

    async function openSettings() {
      try {
        await window.pocketAgent.openSettings();
      } catch (err) {
        console.error('Failed to open settings:', err);
      }
    }

    async function openFactsGraph() {
      try {
        await window.pocketAgent.openFactsGraph();
      } catch (err) {
        console.error('Failed to open facts graph:', err);
      }
    }

    async function openCustomize() {
      try {
        await window.pocketAgent.openCustomize();
      } catch (err) {
        console.error('Failed to open customize:', err);
      }
    }
  </script>
</body>
</html>
